{% extends 'issf_base/base.html' %}

{% load leaflet_tags %}
{% load staticfiles %}
{% load render_table from django_tables2 %}
{% load eztables %}
{% load humanize %}

{% block additional_css_scripts %}
    {% leaflet_css %}
    <link
        rel="stylesheet"
        type="text/css"
        href="{% static 'issf_base/DataTables-1.10.2/media/css/jquery.dataTables.min.css' %}"
    >
    <link rel="stylesheet" href="{% static 'frontend/css/frontend.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/css/selectize.min.css">
    
    

    <style>
        /* css for visual 1*/
        #visual1 { padding-top: 15px; text-align: center; }
        #visual1-info li { display: inline; font-size: 14px; }
        #visual1-info li:after { content: "|"; font-weight: bold; margin-left: 15px; margin-right: 15px; }
        #visual1-info li:last-child:after { content: ""; margin-right: 0; }
        #visual1 svg { width: 100%; }
        .tooltipPopsup { position: fixed; font-size: 15px; width:  auto; height: auto; pointer-events: none; background-color: #feffeb; box-sizing: border-box; padding: 10px; border: 1px solid #e3e3e3; border-radius: 3px; z-index: 999; }

        
        /* css for visual 2*/
        #visual2.svgmap { border: 0px solid  black; }
        #visual2 .svgdiv { text-align: center; }
        #visual2 .hidden { display: none; }
        #visual2 .axis { font: 10px sans-serif; }
        #visual2 .axis path, .axis line { fill: none; stroke: #000; shape-rendering: crispEdges; }
        #visual2 .chart-button { background: white; border-radius: 2; margin-top: -0.5px; margin-right: 0px; margin-bottom: -0.5px; margin-left: 0px; padding: 4px 6px; cursor: pointer; border-radius: 1px; font-family: 'CTVSans-Regular', 'CTV Sans', Arial, Helvetica, sans-serif; }
        #visual2 .button-on { background: #2699FB !important; color: #fff; border: 1px solid #555; }
        #visual2 .button-off { background: #f3f3f3; color: #555; border: 1px solid #555; }
        #visual2 .second-button { background: #fafcd2; border-radius: 2; padding: 4px 6px; cursor: pointer; border-radius: 1px; font-family: 'CTVSans-Regular', 'CTV Sans', Arial, Helvetica, sans-serif; }
        #visual2 .Column { margin-top: 0px; margin-right: 8px; margin-bottom: 9px; margin-left: 0px; display: inline-block; }
        #visual2 #drop select { width: 200px; margin-left: 15px; padding-right: 28px; border-radius: 4px; }
        #visual2 input#myCheckbox { width: 18px; height: 18px; }
        #visual2 #dimensions label { display: inline-block; margin-right: 10px; font-weight: normal; }
        #visual2 #dimensions label input { margin-right: 4px; height: 18px; width: 18px; margin-bottom: 0; }
        #visual2 #dimensions label span {float: right;}
        #visual2 label#myCheckboxLabel { display: inline-block; margin-left: -5px; }
        #visual2 #myCheckboxLabel span { float: right; margin-left: 6px; }
        #visual2 { padding-top: 50px; }
        #visual2 ul { text-align: left; }


        /* css for visual 3*/
        #visual3 { padding-top: 75px; text-align: center; font-size: 14px; } 
        #visual3 div.bluejusticeTooltip { position: fixed; text-align: center; padding: 5px; background: #fff2d1; border: 0px; border-radius: 8px; }
        #visual3 ul { text-align: left; }


        /* css for visual 4 */
        #visual4 { padding-top: 25px; }
        #visual4 .sota-info { margin-bottom: -50px; }
        #visual4 .sota-info h3 { font-size: 20px; }
        #visual4 .sota-info p { font-size: 16px; margin-bottom: 0; }
        #visual4 #barSvg {display: block;}
        #visual4 {font-family:"avenir next", Arial, sans-serif; font-size: 12px; color: #696969;}
        #visual4 .hidden {display: none;}
        #visual4 select { width: auto !important; }
        #visual4 #firstDiv { font-size: 16px; }
        #visual4 #selectedCountries { position: absolute; left: 41%; width: 20px; height: 20px; margin-right: 15px; margin-bottom: 0; }
        
        /* Chart */ 
        #visual4 .label { font-weight: 600; font-size: 13px; }
        #visual4 text.yearText { font-size: 64px; font-weight: 700; opacity: 0.25; }
        #visual4 .tick text { fill: #777777; }
        #visual4 .xAxis .tick:nth-child(2) text { text-anchor: start; }
        #visual4 .tick line { shape-rendering: CrispEdges; stroke: #dddddd; }
        #visual4 .tick line.origin { stroke: #aaaaaa; }
        #visual4 path.domain { display: none; }
        
        /* Buttons */ 
        #visual4 .playpause{ position: absolute; cursor: pointer; border:3px solid #000; border-radius:50%; height:50px; width:50px; text-align:center; background-color:#caddfa; box-shadow: 0px 0px 0px 0px #000; }
        #visual4 .button { position:absolute; left:31%; top:32%; border: 0; background: transparent; box-sizing: border-box; width: 5px; height: 18px; border-color: transparent transparent transparent #202020; transition: 100ms all ease; cursor: pointer; border-style: solid; border-width: 9px 0 9px 20px; padding: 3px 0px 0px; }
        #visual4 button:hover, #visual4 button:focus { box-shadow: none; }
        #visual4 .button.paused { border-style: double; border-width: 0px 0px 0px 20px; left:27%; top:32%; }
        #visual4 .myButton { box-shadow: 0px 2px 0px 0px #1c1b18;background:linear-gradient(to bottom, #eae0c2 5%, #ccc2a6 100% ); background-color:#eae0c2; border-radius:15px; border:2px solid #333029; display:inline-block; cursor:pointer; color:#505739; font-family:Arial; font-size:14px; font-weight:bold; padding:8px 50px; text-decoration:none; text-shadow:0px 1px 0px #ffffff; }
        #visual4 .myButton:hover { background:linear-gradient(to bottom, #ccc2a6 5%, #eae0c2 100%); background-color:#ccc2a6; }
        #visual4 .myButton:active { position:relative; top:1px; }
        
        /* Slider */ 
        #visual4 .track,.track-inset,.track-overlay {stroke-linecap: round;}
        #visual4 .track {stroke: #000; stroke-opacity: 0.3; stroke-width: 10px;}
        #visual4 .track-inset {stroke: #dcdcdc; stroke-width: 8px;}
        #visual4 .track-overlay {pointer-events: stroke; stroke-width: 50px; stroke: transparent; cursor: crosshair;}
        #visual4 .handle {fill: #fff; stroke: #000; stroke-opacity: 0.5; stroke-width: 1.25px;}


        /* css for visual 6 */
        #visual6 { text-align: center; }
        #visual6 .visual6-center { text-align: center; }
        #visual6 .hidden {display: none;}
        #visual6 .button {min-width: 130px; padding: 4px 5px; cursor: pointer;  text-align: center; font-size: 15px; border: 1px solid #e0e0e0;}
        #visual6 .button.active {background: #000;  color: #fff;}
        #visual6 .Column {display: inline-block; vertical-align: top; margin: auto;}
        #visual6 th.headerCountry {top: 0px; background: #c9fdff; color: black; height:20px}
        #visual6 th {padding: 12px;  position: sticky; top: 44px; background: #a88d8d; color: white;}
        #visual6 tr:nth-child(even){background-color: #f2f2f2}
        #visual6 tr:hover {background-color: #ddd;}
        #visual6 td {padding: 5px}
        #visual6 .circle {cursor: pointer;}
        #visual6-info li { display: inline; font-size: 15px; }
        #visual6-info li:after { content: "|"; font-weight: bold; margin-left: 10px; margin-right: 10px; }
        #visual6-info li:last-child:after { content: ""; margin-right: 0; }
        #visual6 #chartDiv { float:left; width: calc(100% - 250px); margin-top: 20px; }
        #visual6 #publications { float: right; }
        #visual6 #footerDiv { float: left; }


        /* css for visual 7 */
        #visual7 {text-align: center;}
        #visual7 .visual7-center {text-align: center;}
        #visual7 svg {font-family: Sans-Serif, Arial;}
        #visual7 .line {stroke-width: 2;    fill: none;}
        #visual7 .axis path {stroke: black;}
        #visual7 .text {font-size: 12px;}
        #visual7 .title-text {font-size: 12px;}
        #visual7 .visual7-Column {display: inline-block; vertical-align: top; margin: auto;}
        #visual7-info li { display: inline; font-size: 15px; }
        #visual7-info li:after { content: "|"; font-weight: bold; margin-left: 10px; margin-right: 10px; }
        #visual7-info li:last-child:after { content: ""; margin-right: 0; }
        #visual7 #visual7-chart { float: left; width: calc(100% - 210px); }
        #visual7 #visual7-right { float: right; width: 210px; }
        #visual7 #visual7-footerDiv { float: left; width: 100%; }
    </style>

{% endblock additional_css_scripts %}
{% block body %}

    <section id="body-section">

        <div class="map-and-visual">
            <div class="map-section">

                <div id="info-section">
                    <div class="row">
                        <div class="large-12 main-wrapper" id="info-map">
                            <h3 style="margin: 0; padding: 0;">ISSF Records</h3>
                            <ul class="tabs" data-tab>
                                <li class="tab-title active">
                                    <a class="tomap" href="#tab-map">Map View</a>
                                </li>
                                <li class="tab-title">
                                    <a class="totable" href="#tab-table">Table View</a>
                                </li>
                            </ul>
                            <div class="info-ctn tabs-content">
                                <!-- Main Map -->
                                <div class="map-holder content active" id="tab-map">
                                    <div id="map-loading-overlay"></div>
                                    <div class="headline"></div>
                                    {% leaflet_map "map" callback="window.map_init_basic" %}
                                </div>
            
                                <!-- Table Tab -->
                                <div class="table-holder content" id="tab-table">
                                    <div class="headline"></div>
                                    <div>
                                        <table id="record-table-result" class="display compact stripe">
                                            <thead>
                                                <tr>
                                                    <th width="180px">Record Type</th>
                                                    <th width="600px">Content Summary</th>
                                                    <th width="150px">Edited Date</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
            
                            <nav class="map-icons">
                                <a id="who" tabindex="0">
                                    <h3>Who's Who in SSF</h3>
                                    <span></span>
                                    <div class="pop">
                                        <p>Information about small-scale fisheries people.</p>
                                        <p><strong>No records.</strong></p>
                                    </div>
                                </a>

                                <a id="sota" tabindex="1">
                                    <h3>State-of-the-Art in SSF Research</h3>
                                    <span></span>
                                    <div class="pop">
                                        <p>Existing published information about small-scale fisheries</p>
                                        <p><strong>No records.</strong></p>
                                    </div>
                                </a>

                                <a id="profile" tabindex="2">
                                    <h3>SSF Profile</h3>
                                    <span></span>
                                    <div class="pop">
                                        <p>Information about a specific small-scale fishery</p>
                                        <p><strong>No records.</strong></p>
                                    </div>
                                </a>

                                <a id="organize" tabindex="3">
                                    <h3>SSF Organization</h3>
                                    <span></span>
                                    <div class="pop">
                                        <p>Organizations directly involved in small-scale fisheries</p>
                                        <p><strong>No records.</strong></p>
                                    </div>
                                </a>

                                <a id="case" tabindex="4">
                                    <h3>Case Studies</h3>
                                    <span></span>
                                    <div class="pop">
                                        <p>Examples of issues/challenges affecting small-scale fisheries</p>
                                        <p><strong>No records.</strong></p>
                                    </div>
                                </a>

                                <a id="governance" tabindex="5">
                                    <h3>SSF Governance</h3>
                                    <span></span>
                                    <div class="pop">
                                        <p>Unlocking legal and policy frameworks for Small-Scale Fisheries</p>
                                        <p><strong>No records.</strong></p>
                                    </div>
                                </a>

                                <a id="bluejustice" tabindex="6">
                                    <h3>Blue Justice Alerts</h3>
                                    <span></span>
                                    <div class="pop">
                                        <p>Alerting the world to injustice and other threats to SSF</p>
                                        <p><strong>No records.</strong></p>
                                    </div>
                                </a>

                                <a id="guidelines" tabindex="7">
                                    <h3>SSF Guidelines</h3>
                                    <span></span>
                                    <div class="pop">
                                        <p>Tracking of the SSF Guidelines implementation worldwide</p>
                                        <p><strong>0 records.</strong></p>
                                    </div>
                                </a>

                                <a id="all" tabindex="11">
                                    <h3>Show/Hide All</h3>
                                    <span></span>
                                    <div class="pop">
                                        <p>Show or hide all available datasets</p>
                                    </div>
                                </a>
                            </nav>
                        </div>
                    </div>
                </div>
            
                <div id="advance-search" class="quick">
                    <a id="tosearch">
                        <h5>Advanced Search</h5>
                    </a>
                    <div class="row header-row">
                        <form id="home-search-form" class="home-search-form-class">
                            {% csrf_token %}
                            <div class="large-12 main-wrapper">
                                <div class="search-wrapper">
                                    <div class="row row-fit" id="quick-search">
                                        <div class="large-4 left" id="quick-search-fulltext-container">
                                            {{ searchForm.fulltext_keywords }}
                                        </div>
            
                                        <div id="quick-country-select" class="large-4 left">
                                            {{ searchForm.countries }}
                                        </div>
            
                                        <div class="large-4 right BtnCol" id="quick-area">
                                            <div id="quick-button-floaty">
                                                <button
                                                    type="submit"
                                                    id="quick-search-button"
                                                    class="medium radius issf-scroll-button"
                                                    scrollto="#info-map"
                                                >
                                                    Search
                                                </button>
                                                <button
                                                    type="button"
                                                    id="quick-reset-button"
                                                    class="medium radius"
                                                >
                                                    Reset
                                                </button>
            
                                                <div
                                                    id="exportModal" class="reveal-modal" data-reveal aria-labelledby="modalTitle"
                                                    aria-hidden="true" role="dialog" style="width:60%; margin-left: -30%;"
                                                >
                                                    <h3 id="modalTitle">Export Data</h3>
                                                    <p>
                                                        ISSF is an online collaborative database, developed and administered by TBTI. As
                                                        a crowdsourcing
            
                                                        platform, ISSF data have been uploaded by individuals but have not been verified
                                                        by TBTI or SSF experts.
            
                                                        Caution should be exercised when using data. The ownership and responsibility
                                                        for the information
            
                                                        provided belongs to the contributors.
                                                        <br>
                                                        <br>
                                                        When using ISSF content, please provide
                                                        appropriate citation,
            
                                                        following the format described in the README file.
                                                    </p>
            
                                                    <a href="#" class="button radius" onclick="exportData();">
                                                        I agree
                                                    </a>
            
                                                    <a class="close-reveal-modal" aria-label="Close">&#215;</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
            
                                    <div class="row row-fit" id="term-search">
                                        <div class="search-term">
                                            <p id="searchTerms" class="EmptyContainer">
                                            </p>
                                        </div>
                                    </div>
            
                                    <div id="full-search">
                                        <div class="row row-fit">
                                            <ul id="search-tabs" class="tabs" data-tab>
                                                <li class="tab-title active">
                                                    <a href="#panel-basic">Basic</a>
                                                </li>
                                                <li class="tab-title">
                                                    <a href="#panel-theme">Themes/Issues</a>
                                                </li>
                                                <li class="tab-title">
                                                    <a href="#panel-character">Characteristics</a>
                                                </li>
                                            </ul>
                                            <button class="reset-button generic-shadow">
                                                <p>Reset</p>
                                            </button>
                                        </div>
            
                                        <div class="tabs-content">
                                            <div class="content active" id="panel-basic">
                                                {{ searchForm.keywords.label }}{{ searchForm.keywords }}
                                                {{ searchForm.contributor.label }}{{ searchForm.contributor }}
                                                {{ searchForm.contribution_begin_date.label }}{{ searchForm.contribution_begin_date }}
                                                {{ searchForm.contribution_end_date.label }}{{ searchForm.contribution_end_date }}
                                                <div id="full-country-select-container">
                                                    {{ searchForm.countries.label }}{{ searchForm.countries }}
                                                </div>
                                            </div>
            
                                            <div class="content" id="panel-theme">
                                                <div>
                                                    {{ selected_themes_issues_formset.management_form }}
                                                    <tr style="background-color: inherit;">
                                                        <td>
                                                            <label>Search by themes/issues</label>
                                                        </td>
                                                    </tr>
                                                    <table
                                                        style="width:100%; background-color: inherit; border: none;"
                                                        class="advancedSearchPanelTabTable"
                                                    >
                                                        {% for form in selected_themes_issues_formset %}
                                                            <tr style="background-color: inherit;">
                                                                <td id="ti-attr-val">
                                                                    {{ form.theme_issue_value }}
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    </table>
                                                </div>
                                            </div>
            
                                            <div class="content" id="panel-character">
                                                <div class="FormSet FormSetGrowable advancedSearchPanelTab">
                                                    {{ selected_attributes_formset.management_form }}
                                                    <table
                                                        class="advancedSearchPanelTabTable"
                                                        style="width:100%; background-color: inherit; border: none;"
                                                    >
                                                        <tr style="background-color: inherit;">
                                                            <td>
                                                                <label>Characteristic</label>
                                                            </td>
                                                            <td>
                                                                <label>Value</label>
                                                            </td>
                                                        </tr>
            
                                                        {% for form in selected_attributes_formset %}
                                                            <tr style="background-color: inherit;">
                                                                <td id="char-attr" style="width: 40%;">
                                                                    {{ form.attribute }}
                                                                </td>
                                                                <td id="char-attr-val" style="width: 40%;">
                                                                    {{ form.attribute_value }}
                                                                </td>
                                                                <td style="width: 20%;">
                                                                    <button
                                                                        class="orangeRedButton advancedSearchPanelTabRemoveButton medium radius"
                                                                        type="button"
                                                                    >
                                                                        Remove
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
            
                                        <div class="large-12 btn-container">
                                            <button
                                                class="medium radius issf-scroll-button"
                                                id="default"
                                                scrollto="#info-map"
                                                type="submit"
                                            >
                                                Search
                                            </button>
            
                                            <div class="BtnCol" style="display:inline;"></div>
                                        </div>
                                    </div>
                                </div>
            
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        
            
            <div id="visual-section" class="visual-section">
                <div class="visual-carousel">
                    <div id="visual-loading-overlay"></div>
                    <div class="slideshow-container">
                        <div id="visual1" class="visual-slides" data-pager="0" style="height: 770px;">
                            <div id="svg-visual1" style="overflow: hidden;"></div>
                            <div style="margin-top:-25px;">
                                <p style="font-size: 14.5px; font-weight: bold; margin-top: 15px; margin-bottom: 0px;">This visualisation shows various governance types by country based on the contributed records (number next to country name)</p>
                                <ul id="visual1-info">
                                    <li>Mouse over the country to see the details</li>
                                    <li>Click to rotate the wheel </li>
                                    <li>Scroll to zoom the chart</li>
                                </ul>
                            </div>
                        </div>

                        
                        <div id="visual2" class="visual-slides" data-pager="1" style="height: 740px;">
                            <div align="center" class="Row">
                                <div class="Column">
                                    <button name="Gear" class="chart-button button-on">Gear</button>
                                    <button name="Vessel" class="chart-button button-off">Vessel</button>
                                </div>
                               
                                <div class="Column">
                                    <button id="perc" name="Percentage" class="second-button button-off">Percentage</button><button id="std" name="Standardized" class="second-button button-on">Standardized Count</button>
                                </div>
                            </div>

                            <div align="center" class="Row2">
                                <div class="Column">
                                    <form id="dimensions">
                                      <label id="country-radio-label" for="country"><input class="radioinput" type="radio" id="country" name="first" checked=""><span>Country</span></label>
                                      <label id="region-radio-label" for="region"><input type="radio" id="region" name="first"><span>Region</span></label>
                                    </form>
                                </div>
                                
                                <label id="myCheckboxLabel" for="myCheckbox"> <input type="checkbox" id="myCheckbox"> <span>Compare</span></label>
                                
                                <div id="drop" align=left class="Column"></div>
                            </div>

                            <div class="svgdiv"></div>

                            <div style="margin-top: -20px;">
                                This visualisation shows vessel/gear types information by country/region
                                <ul>
                                    <li>"Percentage" shows the percentage of a given vessel/gear type used in a country/region</li>
                                     <li>"Standardized Count" shows average number of records using a given vessel/gear in a country/region</li>
                                     <li>To compare country/region choose "Standardized Count" option</li>
                                </ul>
                            </div>
                        </div> <!-- /visual2 -->


                        <div id="visual3" class="visual-slides" data-pager="2" style="height: 700px;">
                            <div style="font-size: 15px; width: 160px; margin: auto; margin-bottom: 32px;">
                                <input type="checkbox" id="sort" style="float: left; width: 20px; height: 20px; margin-bottom: 0; cursor: pointer;margin-right: 15px;"> 
                                <label for="sort" style="float: left;margin: 0;">Sort By Country</label>
                            </div>
                            
                            <svg id="chart" width="750" height="400"></svg><br>
                                <p style=" font-weight: bold; ">This visualisation shows different types of injustice to small-scale fisheries taking place in various case study locations.</p>
                                <ul>
                                    <li>Number on top of the histogram shows the number of case studies reported in each country</li>
                                    <li>Mouseover the justice type in a country to see the total reported number for that type</li>
                                    <li>Results can be sorted by country, click "Sort by Country" </li>     
                                </ul> 
                        </div> <!-- /visual3 end -->


                        <div id="visual4" class="visual-slides" data-pager="3" style="height: 1020px;">
                            <div id="sotaDiv">
                                <div class="sota-info">
                                    <h3>State-of-the-Art in SSF Research</h3>
                                    <p>This visualization shows top 12 countries with the highest number of total themes/issues reported.</p>
                                    <p>First number shows a sum of themes/issues reported while the second number shows the number of ISSF records for the country.</p>
                                    <p>Click "Select Countries" to explore other countries.</p>
                                </div>

                                <svg id='barSvg'></svg>
                                <svg id='sliderSvg'></svg><br><br>
                            </div>

                            <div id="firstDiv" align="center">
                                <input type="checkbox" id="sort" hidden>
                                <input type="checkbox" id="selectedCountries" checked>Select Countries
                                <div id="dropDiv"></div>
                            </div>

                            <div class="playpause">
                                <div id="buttonDiv" align="center"></div>
                            </div>
                        </div> <!-- /visual4 end -->


                        <div id="visual6" class="visual-slides" data-pager="4" style="height: 910px; padding-top: 35px;">
                            <div id="toolbar" align="center">
                                <button id="all" class="button active">All</button>
                                <button id="region" class="button">By Region</button>
                            </div>
                            <div>
                                <div class="Column" id="chartDiv"></div>
                                <div class="Column">
                                    <div id="tableDiv" style="overflow-x:auto; overflow-y:scroll;"></div>
                                </div>
                                <div align="center" id="footerDiv" style="margin-top:-20px;">
                                    <p style="font-size: 17px; font-weight: bold; margin-top: 0px; margin-bottom: 0px;">This visualisation shows the number of researchers in different countries</p>
                                    <ul id="visual6-info" style="margin-top:0px;">
                                        <li>Mouse over the region legend to highlight the countries</li>
                                        <li>Click the country name or region legend to see the list of researchers</li>
                                        <li>Click ‘By Region’ to see clusters of countries</li>
                                    </ul>
                                </div>
                            </div>
                        </div> <!-- /visual6 end -->


                        <div id="visual7" class="visual-slides" data-pager="5" style="height: 770px; padding-top: 35px;">
                            <div id="visual7-chart" class="visual7-Column"></div>
                            <div id="visual7-right" class="visual7-Column">
                                <div id="visual7_dropdown"></div>
                                <label id="visual7-lockCheckboxLabel" for="visual7-lockCheckbox"> <input type="checkbox" id="visual7-lockCheckbox"> <span>Lock</span></label>
                                <div id="visual7-pieChart"></div>
                            </div>
                            <div align="center" id="visual7-footerDiv" style="margin-top:-40px;">
                                <p style="font-size: 16px; font-weight: bold; margin-top: 0px; margin-bottom: 0px;">This visualization shows themes/issues covered in SSF research in various countries</p>
                                <ul id="visual7-info" style="margin-top: 10px;">
                                    <li>Mouseover country line or select from dropdown list to see country info</li>
                                    <li>Mouseover dots on country line to see details for certain years</li>
                                    <li>Check "Lock" or click anywhere on country line to prevent moving to other countries</li>
                                    <li>Explore countries by region using dropdown list and check "Lock"</li>
                                </ul>
                            </div>
                        </div><!-- visual 7 -->
                    </div>

                    <div class="visual-carousel-control hide">
                        <button id="prev-slide">&#8617;</button>
                        <button id="next-slide">&#8618;</button>
                    </div>

                    <div id="pager" class="hide"></div>
                </div>
            </div>
        </div>

    
        <div class="info-section">
            <input id="newload" type="text" style="display:none"/>
            <input id="filterbuttondata" type="text" style="display:none"/>
            <section id="contribute-panel">
                <div id="panel-left">
                    <div id="welcome-note">
                        <div class="box box-info welcome">
                            <header>
                                <h2>Welcome</h2>
                            </header>
                    
                            <div class="body-contribute">
                                <p align="center">ISSF is a global collaborative online database providing information on small-scale fisheries (SSF) to help enhance knowledge about this sector and their overall contributions.</p>
                    
                                <div class="icons-container">
                                    <div class="icons" style="background-image: url({% static 'issf_base/img/icon-who.png' %});"></div>
                                    <div class="icons" style="background-image: url({% static 'issf_base/img/icon-sota.png' %});"></div>
                                    <div class="icons" style="background-image: url({% static 'issf_base/img/icon-profile.png' %});"></div>
                                    <div class="icons" style="background-image: url({% static 'issf_base/img/icon-organize.png' %});"></div>
                                    <div class="icons" style="background-image: url({% static 'issf_base/img/icon-guidelines.png' %});"></div>
                                </div>
                
                                <h6>What can you do with ISSF?</h6>
                                <ul>
                                    <li><strong>Learn</strong> about SSF around the world</li>
                                    <li><strong>Search,</strong> discover, and export data</li>
                                    <li><strong>Share</strong> information about yourself, your research and SSF organizations</li>
                                    <li><strong>Contribute</strong> by creating a profile for SSF that you know,
                                        <a href="{% url 'contribute' %}">online,</a> or using a template (available in
                                        <a href="{% static "pdf/ISSF_Profile_English_Template.pdf" %}" target="_blank"><span>English,</span></a>
                                        <a href="{% static "pdf/ISSF_Profile_French_Template.pdf" %}" target="_blank"><span>French,</span></a>
                                        <span> and </span>
                                        <a href="{% static "pdf/ISSF_Profile_Spanish_Template.pdf" %}" target="_blank"><span>Spanish.</span></a>
                                        )
                                    </li>
                                    <li><strong>Explore</strong> SSF characteristics through charts, tables, and infographics with <a href="{% url 'report-pdf' 'profile' 2288 %}" target="_blank">SSF Profile Reports</a></li>
                
                                    <!--
                                    <li><strong>Visualize</strong> and compare SSF Profiles around the world using the<a href="http://demo.vista.cs.uregina.ca/gcpc-ssf/" target="_blank">GCPC tool</a></li>
                                    -->
                                </ul>
                        
                                <div align="center">
                                    <p style="margin-bottom: -15px;"><u>Need help with ISSF?</u></p>
                                    <p>
                                        See our <a href="http://toobigtoignore.net/wp-content/uploads/2014/11/ISSF-basic-tutorial-1.0.1.pdf" target="_blank">basic</a> or <a href="http://toobigtoignore.net/wp-content/uploads/2014/11/ISSF-advanced-tutorial-1.0.1.pdf" target="_blank">advanced</a> tutorials.
                                        <br>
                                        <span>Or perhaps you will find our video tutorial useful.</span>
                                    </p>
                                </div>

                                <div id="video-tutorial">
                                    <iframe width="100%" height="400px" src="https://www.youtube.com/embed/P2TUCEAAMrg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                </div> <!-- /video-tutorial -->
                            </div> <!-- /body-contribute -->
                        </div> <!-- /box-info-welcome -->
                    </div>  <!-- /welcome -->


                    <div id="most-recent-contributions">
                        <h3>Most Recent Contributions</h3>

                        <ul class="most-recent-contributions-trigger nav nav-tabs">
                          <li class="active"><a data-toggle="tab" data-tab="by-name"><strong>Contributions by Name</strong></a></li>
                          <li><a data-toggle="tab" data-tab="by-type"><strong>Contributions by Type</strong></a></li>
                          <li><a data-toggle="tab" data-tab="by-countries"><strong>Contributions by Countries</strong></a></li>
                        </ul>

                        <div class="tab-content most-recent-contributions-tabs">
                            <div id="by-name" class="box box-contribute tab-pane fade in active">
                                <div class="body-contribute">
                                    <ul>
                                        {# already escaped in view #}
                                        {% autoescape off %}
                                            {% for recent_contribution in recent_contributions %}
                                                <li>
                                                    {% if recent_contribution.core_record_type == "Who's Who in SSF" %}
                                                        <span class="icon cont-who"></span>
                                                        <p>
                                                            <a href="{% url 'who-details' recent_contribution.issf_core_id %}">{{ recent_contribution.core_record_summary }}</a>
                                                        </p>

                                                    {% elif recent_contribution.core_record_type == "State-of-the-Art in SSF Research" %}
                                                        <span class="icon cont-sota"></span>
                                                        <p>
                                                            <a href="{% url 'sota-details' recent_contribution.issf_core_id %}">{{ recent_contribution.core_record_summary }}</a>
                                                        </p>

                                                    {% elif recent_contribution.core_record_type == "SSF Governance" %}
                                                        <span class="icon cont-capacity"></span>
                                                        <p>
                                                            <a href="{% url 'capacity-details' recent_contribution.issf_core_id %}">{{ recent_contribution.core_record_summary }}</a>
                                                        </p>

                                                    {% elif recent_contribution.core_record_type == "SSF Organization" %}
                                                        <span class="icon cont-organize"></span>
                                                        <p>
                                                            <a href="{% url 'organization-details' recent_contribution.issf_core_id %}">{{ recent_contribution.core_record_summary }}</a>
                                                        </p>
                                                    
                                                    {% elif recent_contribution.core_record_type == "SSF Profile" %}
                                                        <span class="icon cont-profile"></span>
                                                        <p>
                                                            <a href="{% url 'profile-details' recent_contribution.issf_core_id %}">{{ recent_contribution.core_record_summary }}</a>
                                                        </p>
                                                    
                                                    {% elif recent_contribution.core_record_type == "SSF Guidelines" %}
                                                        <span class="icon cont-guidelines"></span>
                                                        <p>
                                                            <a href="{% url 'guidelines-details' recent_contribution.issf_core_id %}">{{ recent_contribution.core_record_summary }}</a>
                                                        </p>
                                                        
                                                    {% elif recent_contribution.core_record_type == "SSF Blue Justice" %}
                                                        <span class="icon cont-expe"></span>
                                                        <p>
                                                            <a href="{% url 'bluejustice-details' recent_contribution.issf_core_id %}">{{ recent_contribution.core_record_summary }}</a>
                                                        </p>
                                                    
                                                    {% elif recent_contribution.core_record_type == "SSF Experiences" %}
                                                        <span class="icon cont-expe"></span>
                                                        <p>
                                                            <a href="{% url 'experiences-details' recent_contribution.issf_core_id %}">{{ recent_contribution.core_record_summary }}</a>
                                                        </p>
                                                    
                                                    {% elif recent_contribution.core_record_type == "Case Study" %}
                                                        <span class="icon cont-case"></span>
                                                        <p>
                                                            <a href="{% url 'case-studies-details' recent_contribution.issf_core_id %}">{{ recent_contribution.core_record_summary }}</a>
                                                        </p>
                                                    {% endif %}
                                                </li>
                                            {% endfor %}
                                        {% endautoescape %}
                                    </ul>
                                </div> <!-- /body-contribute -->
                            </div> <!-- /box-contribute -->


                            <div id="by-type" class="box box-contribute tab-pane fade">
                                <div class="body-contribute">
                                    <ul>
                                        {% for contribution in contributions_by_record_type %}
                                        <li>
                                            {% if contribution.core_record_type == "Who's Who in SSF" %}
                                                <span class="icon cont-who"></span>
                                                <p>
                                                    <strong>Who's Who:</strong> 
                                                    {{ contribution.contribution_count }}
                                                </p>
                                            
                                            {% elif contribution.core_record_type == "State-of-the-Art in SSF Research" %}
                                                <span class="icon cont-sota"></span>
                                                <p>
                                                    <strong>State-of-the-Art:</strong> 
                                                    {{ contribution.contribution_count }}
                                                </p>
                                            
                                            {% elif contribution.core_record_type == "SSF Profile" %}
                                                <span class="icon cont-profile"></span>
                                                <p>
                                                    <strong>Profile:</strong> 
                                                    {{ contribution.contribution_count }}
                                                </p>
                                            
                                            {% elif contribution.core_record_type == "SSF Organization" %}
                                                <span class="icon cont-organize"></span>
                                                <p>
                                                    <strong>Organization:</strong> 
                                                    {{ contribution.contribution_count }}
                                                </p>
                                            
                                            {% elif contribution.core_record_type == "SSF Guidelines" %}
                                                <span class="icon cont-guidelines"></span>
                                                <p>
                                                    <strong>Guidelines:</strong> 
                                                    {{ contribution.contribution_count }}
                                                </p>
                                            
                                            {% elif contribution.core_record_type == "SSF Governance" %}
                                                <span class="icon cont-capacity"></span>
                                                <p>
                                                    <strong>SSF Governance:</strong> 
                                                    {{ contribution.contribution_count }}
                                                </p>
                                                
                                                {% elif contribution.core_record_type == "SSF Blue Justice" %}
                                                <span class="icon cont-expe"></span>
                                                <p>
                                                    <strong>Blue Justice Alerts:</strong> 
                                                    {{ contribution.contribution_count }}
                                                </p>
                                            
                                            {% elif contribution.core_record_type == "SSF Experiences" %}
                                                <span class="icon cont-expe"></span>
                                                <p>
                                                    <strong>Experience:</strong> 
                                                    {{ contribution.contribution_count }}
                                                </p>
                                            
                                            {% elif contribution.core_record_type == "Case Study" %}
                                                <span class="icon cont-case"></span>
                                                <p>
                                                    <strong>Case Study:</strong> 
                                                    {{ contribution.contribution_count }}
                                                </p>
                                            
                                            {% endif %}
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div> <!-- /body-contribute -->
                            </div> <!-- /box-contribute -->

                          
                            <div id="by-countries" class="box box-contribute tab-pane fade">
                                <div class="body-contribute">
                                    <ul>
                                        {% for contribution in contributions_by_country %}
                                            <li>
                                                <strong>{{ contribution.short_name }}:</strong>
                                                {{ contribution.contribution_count }} contributions
                                            </li>
                                        {% endfor %}
                                        <li>
                                            <strong>Countries with one contribution:</strong> 
                                            {{ other_countries.count }}
                                        </li>
                                    </ul>
                                </div> <!-- /body-contribute -->
                            </div> <!-- /box-contribute -->

                        </div>
                    </div> <!-- /most-recent-contributions -->
                </div> <!-- /panel-left -->


                <div id="panel-right">
                    <div id="twitter-box" class="twitter-box">       
                        <a class="twitter-timeline" data-height="1738" href="https://twitter.com/TBTInetwork?ref_src=twsrc%5Etfw">Tweets by TBTInetwork</a>
                        <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
                    </div>
                </div>
            </section>

    
        </div>

    </section>
    
{% endblock body %}

{% block additional_js_scripts %}
    {% leaflet_js plugins="cluster,navbar,binggeocoder" %}

    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.7/js/jquery.dataTables.min.js"></script>

    <!-- Note that the chorodata.json file needs to be prefaced with "var choroData = " in order for it to work-->
    <script src="{% static 'frontend/js/chorodata.json' %}"></script>

    <!-- for D3 -->
    <script src="https://d3js.org/d3-array.v1.min.js"></script>
    <script src="https://d3js.org/d3-collection.v1.min.js"></script>
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-format.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-scale.v1.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    
    <script src="{% static "issf_base/issf-js/d3-scale-radial.js" %}"></script>
    



    <!-- Visual 1 -->
    <script>
        // set the dimensions and margins of the graph
        var margin = {top: 30, right: 0, bottom: 0, left: 0}
        var width = 600;
        var height = 620;
            
        // append the svg object to the body of the page
        var svg = d3.select("#svg-visual1")
          .append("svg")
            .attr("width", width)
            .attr("height", height + 30)
            
        var g_scroll =  svg.call(d3.zoom().scaleExtent([1, 3]).on("zoom", function () {
               g_scroll.attr("transform", d3.event.transform)
            }))
            .append("g")
            .attr("id","scroll group")
            
        var innerRadius = 130,
            outerRadius = Math.min(width, height) / 2
        
        var g = g_scroll.append("g")
            .attr("id","main group")
            .attr("transform",
                  "translate(" + width / 2 + "," + height / 2 + ")")
                  
        var x = d3.scaleBand()
            .range([0, 2 * Math.PI])
            .align(0);
        
        var y = d3.scaleRadial()
            .range([innerRadius, outerRadius]);
        
        var z = d3.scaleOrdinal()
            .range(["#0000FF", "#FF4500", "#008000", "#964b00", "#696969"]);
            
        var tooltipPopsup = d3.select("body").append("div")
            .attr("class", "tooltipPopsup")
            .style("opacity", 0);
        
        var mouseover = function(d) {
                              var visualSection = document.getElementById("visual-section");
                              var html  = "Country : " + d.data.country + " | Records : " + d.data.record +"<br/>"; 
                            valueLabel_array.forEach(function (c) { 
                                html  = html + "<font color=" + z(c) + ">" + c + ": " + d.data[c] + "</font><br/>"; 
                            })
                            html  = html + "Total : " + d.data.total + "<br/>"; 
                            // html  = html + "Records : " + d.data.record + "<br/>";
                              tooltipPopsup.html(html)
                                  .style("left", (d3.event.pageX) + "px")
                                  .style("top", (d3.event.pageY) + "px")
                                .transition()
                                  .duration(200) 
                                  .style("opacity", 1) 
                            d3.select(this)
                              .style("stroke", "black")
                              .style("opacity", 1)
                          };
                          
        var mouseleave = function(d) {
                              tooltipPopsup.transition()
                                  .duration(300) // ms
                                  .style("opacity", 0); // don't care about position!
                            d3.select(this)
                              .style("stroke", "none")
                              .style("opacity", 1)
                          };
                          
        var rotate = 0;


        d3.csv("{% static "issf_base/csv/data.csv" %}", function(error, data){
        
    data_nested = d3.nest()
          .key(function(d) { return d.country; }).sortKeys(d3.ascending)
          .key(function(d) { return d.valueLabel; })
          .rollup(function(v) { return {
            length: v.length
          }; })
          .entries(data);

    valueLabel_array = d3.map(data, v => v.valueLabel).keys()

        var new_data = []
        data_nested.forEach(function (d, i) {
            new_data.push({country: d.key, total: 0, record: 0})
            
            var data_country_filtered = data.filter(m => (m.country == d.key))
            var count_issf = d3.map(data_country_filtered, function(c){return c.issf_core_id;}).keys().length
            new_data[i].record = count_issf
            
            valueLabel_array.forEach(function (c) { 
                new_data[i][c] = 0
            })
            
            var total = 0
            d.values.forEach(function (v) {
                new_data[i][v.key] = v.value.length
                total = total + v.value.length
            })
            
            new_data[i].total = total
            
        })
        
    data = new_data
    <!-- console.log("data",data)            -->
          x.domain(data.map(function(d) { return d.country; }));
          y.domain([0, d3.max(data, function(d) { return d.total; })]);
      z.domain(valueLabel_array);
      
        var arc = g.append("g")
                .attr("id", "arc");
                
            arc.append("g")
                .selectAll("g")
                .data(d3.stack().keys(valueLabel_array)(data))
                .enter()
                    .append("g")
                    .attr("fill", function(d) { return z(d.key); })
                    .selectAll("path")
                    .data(function(d) { return d; })
                    .enter()
                        .append("path")
                        .on("mouseover", mouseover)
                        .on("mouseleave", mouseleave)
                        .attr("id", function(d) { return d; })
                        .attr("d", d3.arc()
                              .innerRadius(function(d) { return y(d[0]); })
                              .outerRadius(function(d) { return y(d[1]); })
                              .startAngle(function(d) { return x(d.data.country); })
                              .endAngle(function(d) { return x(d.data.country) + x.bandwidth(); })
                              .padAngle(0.01)
                              .padRadius(innerRadius));
            
        var gg = g
            .selectAll("g") 
            
        var label_dr = d3.arc()
            .outerRadius(500)
            .innerRadius(0);
            
        d3.select("#svg-visual1")
            .on("click",function(d) { 
                                rotate = rotate + 8;
                                
                                gg.transition()
                                    .attr("transform",  "rotate(" + rotate + ")")
                                    .duration(1000);
                                
                                 label.transition()
                                      .attr("text-anchor", "right")                                                                                 //"translate(" + (y(d['Value'])+10) + ",0)"; })
                                      .attr("transform", function(d) { return "rotate(" + (2*rotate+(x(d.country) + x.bandwidth() / 2) * 180 / Math.PI - 90) + ")translate(" + (y(d['total'])+10) + ",-10)"; })
                                        .duration(1000);                
                                });
        
        var label = arc.append("g")
            .attr("id","label")
            .selectAll("g")
            .data(data)
            .enter().append("g")
                .attr("id","labels")
                .attr("text-anchor", "right")                                                                                   //"translate(" + (y(d['Value'])+10) + ",0)"; })
                .attr("transform", function(d) { return "rotate(" + ((x(d.country) + x.bandwidth() / 2) * 180 / Math.PI - 90) + ")translate(" + (y(d['total'])+10) + ",-10)"; });
        
        var text =  label.append("text")
              .attr("transform", function(d) { return (x(d.country) + x.bandwidth() / 2 + Math.PI / 2) % (2 * Math.PI) < Math.PI ? "rotate(0)translate(0,15)" : "rotate(-0)translate(0,15)"; })
              .text(function(d) { return d.country+" "+d.record; })
              .attr("font-weight","normal")
              .style("font-size", "13px")
              .style("font-family", "sans-serif");  
          
          var yAxis = g.append("g")
            .attr("id","yAxis")
            .attr("text-anchor", "middle");
        
          var yTick = yAxis
            .selectAll("g")
            .data(y.ticks(5).slice(1))
            .enter().append("g")
            .attr("id","yTick");
        
          yTick.append("circle")
              .attr("fill", "none")
              .attr("stroke", "#000")
              .attr("stroke-width", 0.4)
              .attr("r", y)
          .style("opacity", 1);
        
          yTick.append("text")
              .attr("y", function(d) { return -y(d); })
              .attr("dy", "0.35em")
              .attr("fill", "none")
              .attr("stroke-width", 5)
              .text(y.tickFormat(5, "s"));
        
          yTick.append("text")
              .attr("y", function(d) { return -y(d); })
              .attr("dy", "0.35em")
              .text(y.tickFormat(5, "s"))
              .style("opacity", 0.4);;
        
          yAxis.append("text")
              .attr("y", function(d) { return -y(y.ticks(5).pop()); })
              .attr("dy", "-1em")
              .text("No. of each type");
              
          var legend = g.append("g")
            .attr("id","legend")
            .selectAll("g")
            .data(valueLabel_array)
            .enter().append("g")
            .attr("id","legends")
            .attr("transform", function(d, i) { return "translate(-112," + (i - (valueLabel_array.length) / 2) * 20 + ")"; });
        
          legend.append("rect")
              .attr("width", 18)
              .attr("height", 18)
              .attr("fill", z);
        
          legend.append("text")
              .attr("x", 24)
              .attr("y", 9)
              .attr("dy", "0.35em")
              .style("font-size", "12px")
              .style("font-family", "sans-serif")
              .text(function(d) { return d; }); 

            g.style('transform', 'translate(50%, 50%)');
        });
        
    </script>
    <!-- Visual 1 end -->




    <!-- Visual 2 -->
    <script>
        var margin = {top: 20, right: 10, bottom: 150, left: 60, space : 2},
            width = 665,
            height = 450 - margin.top - margin.bottom;
                    
        var svg = d3.select("#visual2 .svgdiv").append("svg")
            .attr("class", "svgmap")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            
        var underConstr = svg.append("g")
                    .attr("class", "under hidden")
                    .attr("transform", "translate(100,100)")
                    
        underConstr.append("text").text("Under Construction :)")

        d3.csv("{% static "issf_base/csv/gear.csv" %}", function(error, data){
            
            //Read data by Gear or Vessel
            var data = data.filter(function(d){return d.attribute_value__value_label != '';});
            
            var main_gear = data.filter(function(d){return d.attribute__attribute_label == 'Main gear type(s):';});
            var main_vessel = data.filter(function(d){return d.attribute__attribute_label == 'Main SSF vessel type(s):';});

            //Get Types for Gear
            var regions_array = data.map(function(x) { return x.region; }); 
            regions_array = regions_array.filter(function(elem, pos) {
              return regions_array.indexOf(elem) == pos;
            });

            //Get Types for Gear
            var types_gear = main_gear.map(function(x) { return x.attribute_value__value_label; }); 
            types_gear = types_gear.filter(function(elem, pos) {
              return types_gear.indexOf(elem) == pos;
            });
            
            //Get Types for Vessel
            var types_vessel = main_vessel.map(function(x) { return x.attribute_value__value_label; }); 
            types_vessel = types_vessel.filter(function(elem, pos) {
              return types_vessel.indexOf(elem) == pos;
            });
            
            //Draw Bar Chart
            function drawGraph(main, drop_selected, types, regionOrCountry){
                var dG = {};
                //Groupping data by type for average  /////////old calc
                data_count = d3.nest()
                      .key(function(d) { return d.attribute_value__value_label; })
                      .rollup(function(v) { return {
                        length: v.length
                      }; })
                      .entries(main);
                      
                //Groupping data //cal 1 ok
                data_gear = d3.nest()
                      .key(function(d) { return d.country})
                      .key(function(d) { return d.attribute_value__value_label; })
                      .rollup(function(v) { return {
                        length: v.length
                      }; })
                      .entries(main);
                      
                //Sum of country labels //calc 2
                data_gear.forEach(function (d) {
                    if (regionOrCountry == "region"){
                        region = main.filter(function(m){return m.country == d.key;}).map(function(r) { return r.region; });  //main.map(function(x) { return x.region; }); 
                        d.region = region[0]
                    }
                    
                    //Groupping data by type for average  /////////old calc
                    data_other = d3.nest()
                          .key(function(d) { return d.issf_core_id;})
                          .rollup(function(v) { return {
                            length: v.length
                          }; })
                          .entries(main.filter(function(m){return m.country == d.key && m.attribute_value__value_label == "Other";}));
                    
                    records = d3.sum(data_other,function(v){return v.value.length;}) - data_other.length
                    
                    var data_issf = d3.map(main.filter(function(m){return m.country == d.key;}), function(m){return m.issf_core_id;}).keys()

                    d.total = d3.sum(d.values,function(v){return v.value.length;})
                    d.records = records + data_issf.length
                })  
                    
                //add new length and sum of types ///calc 3 & 4
                data_gear.forEach(function (d) {
                    d.values.forEach(function (v) {
                        v.value.std = +d3.format(".5f")((v.value.length/d.records*100))
                        v.value.perc = +d3.format(".5f")((v.value.length/d.total))
                    });
                });

                if (regionOrCountry == "region"){ 
                    var new_data = [];
                    data_gear.forEach(function (d) {
                        d.values.forEach(function (v) {
                            new_data.push({region: d.region, type: v.key, length: v.value.length})
                        });
                    });
                    
                    //Groupping data by type for average 
                    new_data_nested = d3.nest()
                          .key(function(d) { return d.region; })
                          .key(function(d) { return d.type; })
                          .rollup(function(v) { return {
                            length: d3.sum(v, function(d) { return d.length; })
                          }; })
                          .entries(new_data);
                          
                    new_data_nested.forEach(function (d) {
                        d.total = d3.sum(d.values,function(v){return v.value.length;})
                        d.records = d3.sum(data_gear.filter(function(m){return m.region == d.key;}),function(v){return v.records;})
                    });   
                    
                    new_data_nested.forEach(function (d) {
                        d.values.forEach(function (v) {
                            v.value.std = +d3.format(".5f")((v.value.length/d.records*100))
                            v.value.perc = +d3.format(".5f")((v.value.length/d.total))
                        });
                    });

                    data_gear = new_data_nested
                }

                var format_scale = d3.scaleOrdinal()
                        .domain(["std","perc"])
                        .range([".2f",".2%"]); //".2%"
                
                var format_scale_yAxis = d3.scaleOrdinal()
                        .domain(["std","perc"])
                        .range([".0f",".0%"]); //
                
                //Set Axiss
                var x0 = d3.scaleBand()
                        .domain(types)
                        .rangeRound([0, width])
                        .paddingInner(0.1); 
                        
                var y = d3.scaleLinear()
                        .range([height, 0]);
                        
                var xAxis = d3.axisBottom(x0)
                var yAxis = d3.axisLeft(y).tickFormat(d3.format(format_scale_yAxis(countOrPerc)));

                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis)
                        .selectAll("text")
                        .style("font-size", "13px")
                        .style("font-family", "sans")
                        .style("text-anchor", "end")
                        .attr("dx", "-.8em")
                        .attr("dy", ".55em")
                        .attr("transform", "rotate(-30)" );

                svg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis)
                    .append("text")
                      .attr("transform", "rotate(-90)")
                      .attr("y", 6)
                      .attr("dy", ".71em")
                      .style("text-anchor", "end")
                      .style('font-weight','bold')
                      
                //Updateing by DropDown
                dG.update = function(drop_selected, types, turn){
                
                //Filtering selected Country
                selection = []
                selection_new = []
                var selection = data_gear.filter(function(d){return d.key == uniqueCountryArray[drop_selected[0]];});
                if (selection == "") {selection.push({key : uniqueCountryArray[drop_selected[0]],values : []})}
                selection.push(data_gear.filter(function(d){return d.key == uniqueCountryArray[drop_selected[1]];})[0]);
                if (!selection[1]) {selection[1] = {key : uniqueCountryArray[drop_selected[1]],values : []}}
                    
                //Adding nonExist Types to Country
                for(var i =0;i<types.length;i++){   
                    var a=0;
                    for(var j =0;j<selection[0].values.length;j++){ 
                        if (types[i] == selection[0].values[j].key) {var a=1;}
                    }
                    if (a==0){selection[0].values.push({key : types[i],value : {length : 0, perc : 0, std : 0}})}
                    
                    var a=0;
                    for(var j =0;j<selection[1].values.length;j++){ 
                        if (types[i] == selection[1].values[j].key) {var a=1;}
                    }
                    if (a==0){selection[1].values.push({key : types[i],value : {length : 0, perc : 0, std : 0}})}
                    
                    selection_new.push({key : types[i],values : []})
                }
                
                //Merge two Selected Dropdown
                for(var i =0;i<selection_new.length;i++){
                    for(var j =0;j<2;j++){
                        std = selection[j].values.filter(function(d) {return d.key == selection_new[i].key})[0].value.std
                        perc = selection[j].values.filter(function(d) {return d.key == selection_new[i].key})[0].value.perc
                        selection_new[i].values.push({std : std, perc : perc, country : uniqueCountryArray[drop_selected[j]]})
                    }
                }
                
                 //Color and Axis
                var inlineCountry = selection_new[0].values.map(function(d) { return d.country; });
                
                var color = d3.scaleOrdinal()
                    .domain(inlineCountry)
                    .range(["blue","#f25618"]); 
                
                var x1 = d3.scaleBand()
                        .domain(inlineCountry)
                        .rangeRound([0, x0.bandwidth()]);
                
                var y = d3.scaleLinear()
                        .domain([0, d3.max(selection_new, function(categorie) { return d3.max(categorie.values, function(d) { return d[countOrPerc]; }); })]) //[countOrPerc]
                        .range([height, 0]);

                yAxis.scale(y)
                    .tickFormat(d3.format(format_scale_yAxis(countOrPerc)));
                
                //Append Slice Group for xAxis
                var slice = svg.selectAll(".types")
                  .data(selection_new)
                  
                slice.enter().append("g")
                      .attr("class", "types")
                      .attr("transform",function(d) { return "translate(" + x0(d.key) + ",0)"; });
                
                //Append Country to Slice Group
                var sliceCountry = slice.selectAll("rect")
                    .data(function(d){return d.values; });  
                
                sliceCountry.enter().append("rect")
                    .attr('height', 0);
            
                slice.selectAll("rect")
                    .attr("name", function(d,i) {  return d.country; })
                    .attr("class","rectangle")
                    .attr("width", x1.bandwidth())
                    .attr("x", function(d) { return x1(d.country);})
                    .style("fill", function(d) { return color(d.country) })
                    .on("mouseover", function(d) {
                          d3.select(this).style("fill", d3.rgb(color(d.country)).darker(2)); 
                      })
                      .on("mouseout", function(d) {
                          d3.select(this).style("fill", color(d.country));
                        })
                    .append("title")
                        .attr("class", "title")
                        .text(function(d){
                            return d.country + " : " + d3.format(format_scale(countOrPerc))(d[countOrPerc]); 
                        });
                    
                    if (turn == 1){
                        slice.selectAll("rect")
                            .attr("y", function(d) { return y(0); })
                            .attr("height", function(d) { return height - y(0); })
                    }

                    slice.selectAll("rect")
                      .transition()
                      .duration(1000)
                      .attr("y", function(d) { return y(d[countOrPerc]); })
                      .attr("height", function(d) { return height - y(d[countOrPerc]); });
              
                    d3.selectAll("g.y.axis")
                        .transition()
                        .duration(1000)
                        .call(yAxis);
                }
                
                inlineCountryId = []
                inlineCountryId.push(+d3.select('#visual2 #dropdown').property('value'),+d3.select('#visual2 #dropdown2').property('value'))
                        
                //plot selected button
                selected_button = d3.select(".chart-button.button-on").attr("name")
                
                if (selected_button == "Gear") {dG.update(inlineCountryId, types_gear, 1)}
                else if (selected_button == "Vessel") {dG.update(inlineCountryId, types_vessel, 1)}
                else if (selected_button == "GearVessel") {GearVessel("GearVessel")}                                
                
                return dG;
            }
            
            
            /////////Third Steps//////////
            function fillDropdown(uniqueCountryArray){
                //Clear Dropdown
                document.querySelectorAll('#visual2 option').forEach(guardian => guardian.remove()) 
                selector.selectAll("#visual2 option")
                  .data(uniqueCountryArray)
                  .enter()
                  .append("option")
                      .attr("value", function(d, i){
                        return i;
                      })
                      .text(function(d){
                        return d;
                  })
                  
                selector2.selectAll("#visual2 option")
                  .data(uniqueCountryArray)
                  .enter()
                  .append("option")
                      .attr("value", function(d, i){
                        return i;
                      })
                      .text(function(d){
                        return d;
                  })
            
                d3.select('#visual2 #dropdown').property('value',FirstDropId)
                d3.select('#visual2 #dropdown2').property('value',SecondDropId)
                radioCheck = 0
            }
            
            function changeIt(){
            //Clear visual
            d3.selectAll(".types").remove()
            d3.selectAll(".rectangle").remove()
            d3.selectAll(".axis").remove()
                        
            //Calculate uniqueCountryArray by Radio
            //Select Checked Radio
            var form = document.getElementById("dimensions")  
            for(var i=0; i<form.length; i++){
            if(form[i].checked){
                if (form[i].name == "first") {form_val = form[i].id;}
            }}
                  
            //Get Countries or Regions
            var country = data.map(function(x) { return x[form_val]; }); 
            uniqueCountryArray = country.filter(function(elem, pos) {
              return country.indexOf(elem) == pos;
            });
            uniqueCountryArray = uniqueCountryArray.sort(d3.ascending)

            //Selected Country Canada & USA
            if (form_val == "country") {
                FirstDropId = uniqueCountryArray.indexOf("Canada")
                SecondDropId = uniqueCountryArray.indexOf("United States of America")
            }
            else if (form_val == "region") {
                FirstDropId = uniqueCountryArray.indexOf("Europe")
                SecondDropId = uniqueCountryArray.indexOf("North America and Canada")
            }
                
            if (radioCheck == 1){fillDropdown(uniqueCountryArray)}
            
            if(d3.select("#visual2 #myCheckbox").property("checked")){
                d3.select('#visual2 #dropdown2').classed("hidden", false)
            } 
            else {
                d3.select('#visual2 #dropdown2').property('value',d3.select('#visual2 #dropdown').property('value'))
                d3.select('#visual2 #dropdown2').classed("hidden", true)     
            }
            
            //Gear or Vessel
            selected_button = d3.select(".button-on").attr("name")
            
            //Count or Perc
            countOrPerc = d3.select(".second-button.button-on").attr("id")
            
            var inlineCountryId = []
                inlineCountryId.push(+d3.select('#visual2 #dropdown').property('value'),+d3.select('#visual2 #dropdown2').property('value'))
                
                if (selected_button == "Gear") {drawGraph(main_gear, inlineCountryId, types_gear, form_val)}
                    else if (selected_button == "Vessel") {drawGraph(main_vessel, inlineCountryId, types_vessel, form_val)}
                    else if (selected_button == "GearVessel") {GearVessel("GearVessel")}
                    
                if (selected_button == "Gear") {drawGraph(main_gear, inlineCountryId, types_gear, form_val)}
                    else if (selected_button == "Vessel") {drawGraph(main_vessel, inlineCountryId, types_vessel, form_val)}
                    else if (selected_button == "GearVessel") {GearVessel("GearVessel")}
            }
            
            
            /////////Second Steps//////////
            
            function button_click() {
                underConstr.classed("hidden", true)
                if (d3.select(this).classed("chart-button")){selected_tab = "chart-button"}
                else if (d3.select(this).classed("second-button")){selected_tab = "second-button"}
                
                //Disabled Compare
                if (selected_tab == "second-button"){
                    if (d3.select(this).attr("id") == "perc"){
                        d3.select("#myCheckbox").property("disabled",true)
                        d3.select("#myCheckbox").property("checked",false)
                    }else{
                        d3.select("#myCheckbox").property("disabled",false)
                    }
                
                }
                
                //change button class
                d3.selectAll("."+selected_tab).classed("button-on", false)
                d3.selectAll("."+selected_tab).classed("button-off", true)
                d3.select(this).classed("button-off", false)
                d3.select(this).classed("button-on", true)
                
                changeIt()
            }
            
            function GearVessel(data) {
                underConstr.classed("hidden", false)
            }
                
            function radioChange(){
                radioCheck = 1
                changeIt()
            }
            
            function update_checkbox(){
                if(d3.select("#visual2 #myCheckbox").property("checked")){
                    d3.select('#visual2 #dropdown2').classed("hidden", false)
                    if (form_val == "country") {
                        SecondDropId = uniqueCountryArray.indexOf("United States of America")
                    }
                    else if (form_val == "region") {
                        SecondDropId = uniqueCountryArray.indexOf("North America and Canada")
                    }
                    d3.select('#visual2 #dropdown2').property('value',SecondDropId)
                } 
                else {
                    d3.select('#visual2 #dropdown2').property('value',d3.select('#visual2 #dropdown').property('value'))
                    d3.select('#visual2 #dropdown2').classed("hidden", true)     
                }
                dropChange()
            }
                    
            let dropChange = function(d) {
                d3.selectAll(".title").remove()
                
                if(!d3.select("#visual2 #myCheckbox").property("checked")){d3.select('#visual2 #dropdown2').property('value',d3.select('#visual2 #dropdown').property('value'))}
                        
                inlineCountryId = []
                inlineCountryId.push(+d3.select('#visual2 #dropdown').property('value'),+d3.select('#visual2 #dropdown2').property('value'))
                
                //Gear or Vessel
                selected_button = d3.select(".button-on").attr("name")
                        
                if (selected_button == "Gear") {dG.update(inlineCountryId, types_gear, 0)}
                else if (selected_button == "Vessel") {dG.update(inlineCountryId, types_vessel, 0)}
            }
            
            
            /////////First Steps//////////
                    
            //Buttons
            d3.selectAll("#visual2 button").on("click", button_click);
            
            //Radio Buttons
            var dataDim = d3.select("#visual2 #dimensions")
                dataDim.on("change", radioChange)
            
            //CheckBox
            d3.select("#visual2 #myCheckbox").on("change",update_checkbox);
            
            //First Dropdown
            var selector = d3.select("#visual2 #drop")
                    .append("select")
                    .attr("id","dropdown")
                    .style("border", "2px")
                    .style("border-style", "outset")
                    .style("border-color", "blue") 
                    .on("change", dropChange);
                    
            //Second Dropdown
            var selector2 = d3.select("#visual2 #drop")
                    .append("select")
                    .attr("id","dropdown2")
                    .style("border", "2px")
                    .style("border-style", "outset")
                    .style("border-color", "#f25618")
                    .on("change", dropChange);
            
            //Globale Variables
            var FirstDropId,SecondDropId,form_val,countOrPerc,uniqueCountryArray,inlineCountryId;
            var radioCheck = 1;
            
            changeIt()
            
            var dG = drawGraph(main_gear, inlineCountryId, types_gear, form_val)
            
        });
    </script>
    <!-- Visual 2 End -->




    <!-- Visual 3 -->
    <script>
        // Load external datas
        d3.queue()
          .defer(d3.csv, "{% static "issf_base/csv/bluejustice.csv" %}")
          .await(ready);

        function ready(error, data) {

            var data_types = data.columns.slice(3);
            
            var data_country = d3.map(data, function(d) { return d.ssf_country; }).keys()
                .sort(d3.ascending)
            
            var data_array = []
            for(var i =0;i<data_country.length;i++){
                
                var data_country_filtered = data.filter(m => (m.ssf_country == data_country[i]))
                var count_issf = d3.map(data_country_filtered, function(c){return c.issf_core_id;}).keys().length
                
                data_array.push({country: data_country[i], total: 0, record: count_issf})
                for(var j =0;j<data_types.length;j++){
                     data_array[i][data_types[j]] = 0
                }
            }
                
            for(var i =0;i<data.length;i++){
                index = data_array.findIndex(x => x.country === data[i].ssf_country)
                for(var j =0;j<data_types.length;j++){
                    if (data[i][data_types[j]] != ""){
                        data_array[index][data_types[j]] = data_array[index][data_types[j]] + 1
                        data_array[index].total = data_array[index].total + 1
                    }
                }
            }
            
            csv = data_array

            var keys = data_types

            // Define 'div' for tooltips
            var div = d3.select("#visual3")
                .append("div")  
                .attr("class", "bluejusticeTooltip")             
                .style("opacity", 0);                
            
            //SVG elements
            var svg = d3.select("#chart"),
                margin = {top: 75, left: 40, bottom: 0, right: 0},
                width = +svg.attr("width") - margin.left - margin.right,
                height = +svg.attr("height") - margin.top - margin.bottom
                
            var x = d3.scaleBand()
                .range([margin.left, width - margin.right])
                .padding(0.1)

            var y = d3.scaleLinear()
                .rangeRound([height - margin.bottom, margin.top])

            var xAxis = svg.append("g")
                .attr("transform", `translate(0,${height - margin.bottom})`)
                .attr("class", "x-axis")

            var yAxis = svg.append("g")
                .attr("transform", `translate(${margin.left},0)`)
                .attr("class", "y-axis")

            var z = d3.scaleOrdinal(d3.schemeTableau10);

            //Legend
            var legspacing = 140;
            
            var legend = svg.selectAll(".legend")
                .data(data_types)
                .enter()
                .append("g")
                        
            legend.append("rect")
                .attr("fill", function (d) {
                    return z(d);
                    })
                .attr("width", 20)
                .attr("height", 20)
                .attr("x", function (d, i) {
                    return (i<=4)? (i * legspacing)+legspacing : ((i * legspacing) - (legspacing*5))+legspacing;
                    })
                .attr("y", function (d, i) {
                    return (i<=4)?10:35;
                    })
                .transition()
                    .ease(d3.easeBack)
                    .delay(0)
                    .duration(1000)
                    .attr("x", function (d, i) {
                        return (i<=4)?i * legspacing : (i * legspacing) - (legspacing*5);
                        });

            legend.append("text")
                .attr("class", "label")
                .attr("x", function (d, i) {
                    return (i<=4)?i * legspacing+25 : (i * legspacing) - (legspacing*5)+25;
                    })
                .attr("y", function (d, i) {
                    return (i<=4)?25:50;
                    })
                .attr("text-anchor", "start")
                .text(function (d, i) {
                    return data_types[i];
                    })
                .attr("opacity", 0)
                .transition()
                        .ease(d3.easeLinear)
                        .delay(500)
                        .duration(2000)
                .attr("opacity", 1);

            var data = csv

                y.domain([0, 2+d3.max(data, function(d) { return d.total; })]).nice();

                data.sort(d3.select("#sort").property("checked")
                    ? (a, b) => data_country.indexOf(a.country) - data_country.indexOf(b.country)
                    : (a, b) => b.total - a.total)

                x.domain(data.map(d => d.country));

                var group = svg.selectAll("g.layer")
                    .data(d3.stack().keys(keys)(data), d => d.key)

                group.exit().remove()

                group.enter().append("g")
                    .classed("layer", true)
                    .attr("fill", d => z(d.key));

                var bars = svg.selectAll("g.layer").selectAll("rect")
                    .data(d => d, e => e.data.country)
                  
                bars.exit().remove()
                
                bars.enter().append("rect")
                    .attr("width", x.bandwidth())
                    .on("mouseover", function() { div.style("display", "block"); }) //.style("width", "100px")
                    .on("mousemove", function(d) {  
                        var typeName = d3.select(this.parentNode).datum().key; 
                        var typeValue = d.data[typeName];
                        var total = d.data.total;
                        div.style("opacity", .9);
                        
                        div.html(
                             "<b>" + typeName + " : "  + typeValue +                 
                            "</b><br>" + d.data.country + " : "  + total)
                            
                            .style("left", (d3.event.pageX + 10) + "px")          
                            .style("top", (d3.event.pageY - 45) + "px");
                        })
                    .on("mouseout", function() { div.style("display", "none"); })
                    .merge(bars)
                    .transition().duration(0)
                        .attr("x", d => x(d.data.country))
                        .attr("y", d => y(0))
                        .attr("height", d => 0)
                      
                //Max Count  
                var text = svg.selectAll(".text")
                    .data(data, d => d.country);

                text.exit().remove()

                text.enter().append("text")
                    .attr("class", "text")
                    .attr("text-anchor", "middle")
                    .merge(text)
                .transition().duration(0)
                    .attr("x", d => x(d.country) + x.bandwidth() / 2)
                    .attr("y", d => y(0) - 5)
                    .text(d => d.record)

            update(1000)

            function update(speed) {
                var data = csv

                y.domain([0, 2+d3.max(data, function(d) { return d.total; })]).nice();

                svg.selectAll(".y-axis").transition().duration(speed)
                    .call(d3.axisLeft(y).ticks(null, "s"))

                data.sort(d3.select("#sort").property("checked")
                    ? (a, b) => data_country.indexOf(a.country) - data_country.indexOf(b.country)
                    : (a, b) => b.total - a.total)

                x.domain(data.map(d => d.country));

                svg.selectAll(".x-axis").transition().duration(speed)
                    .call(d3.axisBottom(x).tickSizeOuter(0)).selectAll("text")  
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr("transform", "rotate(-35)");

                var group = svg.selectAll("g.layer")
                    .data(d3.stack().keys(keys)(data), d => d.key)

                group.exit().remove()

                group.enter().append("g")
                    .classed("layer", true)
                    .attr("fill", d => z(d.key));

                var bars = svg.selectAll("g.layer").selectAll("rect")
                    .data(d => d, e => e.data.country)
                  
                bars.exit().remove()
                
                bars.enter().append("rect")
                    .attr("width", x.bandwidth())
                    .on("mouseover", function() { div.style("visibility", "visible");}) //.style("width", "100px")
                    .on("mousemove", function(d) {  
                        var typeName = d3.select(this.parentNode).datum().key; 
                        var typeValue = d.data[typeName];
                        var total = d.data.total;
                        div.style("opacity", .9);
                        
                        div.html(
                             "<b>" + typeName + " : "  + typeValue +                 
                            "</b><br>" + d.data.country + " : "  + total)
                            
                            .style("left", (d3.event.pageX) + "px")          
                            .style("top", (d3.event.pageY - 45) + "px");
                        })
                    .on("mouseout", function() { div.style("visibility", "hidden"); })
                    .merge(bars)
                    .transition().duration(speed)
                        .attr("x", d => x(d.data.country))
                        .attr("y", d => y(d[1]))
                        .attr("height", d => y(d[0]) - y(d[1]))
                      
                //Max Count  
                var text = svg.selectAll(".text")
                    .data(data, d => d.country);

                text.exit().remove()

                text.enter().append("text")
                    .attr("class", "text")
                    .attr("text-anchor", "middle")
                    .merge(text)
                .transition().duration(speed)
                    .attr("x", d => x(d.country) + x.bandwidth() / 2)
                    .attr("y", d => y(d.total) - 5)
                    .text(d => d.record)
              
            } //function update(speed)

            var checkbox = d3.select("#sort")
                .on("click", function() {
                    update(750)
                })
        } //function ready(error, data)
    </script>
    <!-- Visual 3 End -->



    
    <!-- Visual 4 -->
    <script>
        var Global = "Global Data"
        var tickDuration = 2000;
        var init = 0
        var clear = false
        let year = 2000;
        var lastYear = 2020
        var rangeYear = lastYear - year
        
        var top_n = 12;
        var visual4Height = 490;
        var visual4Width = 960;
       
        const sotaMargin = {
          top: 80,
          right: 200,
          bottom: 0,
          left: 20
        };
      
        var visual4svg = d3.select("#visual4 #barSvg")
          .attr("width", visual4Width + sotaMargin.left + 44)
          .attr("height", visual4Height)
          .append("g")
        
         var fo = visual4svg.append('foreignObject')
                        .attr('x', visual4Width/2)
         var div = fo.append('xhtml:div')
                        .attr("class", "playLocation")

    ////////////////////////////////////////////////////////////// Button //////////////////////////////////////////////////////
        var buttonDiv = d3.select("#visual4 #buttonDiv")
                    .attr("class", "buttonDiv")
                    
        var button = buttonDiv
                    .append("button")
                    .attr("class", "button")
                    
       function redraw(){
       
       var x = d3.selectAll("#visual4 .playLocation")["_groups"][0][0].getBoundingClientRect().left
       
            d3.selectAll("#visual4 .playpause")
                    .style("right", "40%")        
                    .style("top",  visual4Height-sotaMargin.bottom-90 + "px")
       }

        
        redraw();
          
        window.addEventListener("resize", redraw);
        

    ////////////////////////////////////////////////////////////// Info //////////////////////////////////////////////////////
    let subTitle = visual4svg.append("text")
     .attr("class", "title")
     .attr('x', visual4Width-sotaMargin.right)
     .attr("y", 60)
     .html("Country | # Issues | # Records");


    ////////////////////////////////////////////////////////////// READING CSV //////////////////////////////////////////////////////
        d3.csv("{% static "issf_base/csv/sota.csv" %}", function(error, data){
        
            var data = data.filter(d => d.year != "1973")
            var country = d3.map(data, d => d.country).keys()
            country.push(Global)
            var category = d3.map(data, d => d.category).keys()
            
    ////////////////////////////////////////////////////////////// DATA MANIPULATION //////////////////////////////////////////////////////
        var total = {} 
        var totalStd = {} 
        var totalCategory = {}
        var totalRecord = {}
        var totalStdCategory = {}
        country.forEach(function (d) {
            total[d] = 0
            totalStd[d] = 0
            totalCategory[d] = []
            totalRecord[d] = 0
            totalStdCategory[d] = []
            
            category.forEach(function (cat) {
                totalCategory[d][cat] = 0
                totalStdCategory[d][cat] = 0
            })
        })
        
        //Grouping by year and country
        data_nested = d3.nest()
              .key(function(d) { return d.year; }).sortKeys(d3.ascending)
              .key(function(d) { return d.country; })
              .rollup(function(v) { return {
                length: v.length
              }; })
              .entries(data);
        
        var new_data = []
        var i = 0
        data_nested.forEach(function (d) {
            //Add All country to each year array
            new_country = d3.map(d.values, v => v.key).keys()
            var sum = d3.sum(d.values, v=> v.value.length)
            country.forEach(function (c) {
                if(new_country.indexOf(c)===-1){
                    if (c === Global){
                        d.values.push({key: c, value: {length: sum}})
                    }else{
                        d.values.push({key: c, value: {length: 0}})
                    }
                }
            })
            
            var data_year_filtered = data.filter(m => (m.year == d.key))
            
            //Create new array
            d.values.forEach(function (v) {
                    //Find Standardized count
                    if (v.key == Global){
                        var data_country_filtered = data_year_filtered
                    }else{
                        var data_country_filtered = data_year_filtered.filter(m => (m.country == v.key))
                    }
                    var count_issf = d3.map(data_country_filtered, function(c){return c.issf_core_id;}).keys().length
                
                    totalRecord[v.key] = totalRecord[v.key] + count_issf
                    
                    if (count_issf == 0) {
                        totalStd[v.key] = totalStd[v.key] + 0
                    }else{
                        totalStd[v.key] = totalStd[v.key] + v.value.length/count_issf
                    }
                    
                    total[v.key] = total[v.key] + v.value.length
                
                new_data.push({year: d.key, name: v.key, value: total[v.key], std: totalStd[v.key], totalRecord : totalRecord[v.key], stdCat : [], length: v.value.length,  rank: 0})
                
                category.forEach(function (cat) {
                    var catLength = data_country_filtered.filter(m => (m.category == cat)).length
                    totalCategory[v.key][cat] = totalCategory[v.key][cat] + catLength
                    new_data[i][cat] = totalCategory[v.key][cat]
                })
                i = i + 1
            });
        })

        data = new_data

        data.forEach(d => {
            d.value = +d.value,
            d.std = +d.std,
            d.value = isNaN(d.value) ? 0 : d.value,
            d.year = +d.year
        });

    ////////////////////////////////////////////////////////////// Legend //////////////////////////////////////////////////////
        var z = d3.scaleOrdinal(["#ffca3a","#8ac926","#1982c4","#6a4c93"]); 
        
        var legsize = 20;
        
        var legendCat = visual4svg.selectAll("#visual4 .legend")
                    .data(category)
                    .enter()
                    .append("g")
                    
        legendCat.append("rect")
                    .attr("fill", function (d) {
                        return z(d);
                        })
                    .attr("width", legsize)
                    .attr("height", legsize)
                    .attr("x", function (d, i) {
                        return visual4Width-sotaMargin.right;
                        })
                    .attr("y", function (d, i) {
                        return visual4Height/2+i*30;
                        });

        legendCat.append("text")
                    .attr("class", "labelCat")
                    .attr("x", function (d, i) {
                        return visual4Width-sotaMargin.right+legsize+5;
                        })
                    .attr("y", function (d, i) {
                        return visual4Height/2+i*30+legsize/2+3;
                        })
                    .attr("text-anchor", "start")
                    .text(function (d, i) {
                        return category[i];
                        });

    ////////////////////////////////////////////////////////////// INITIAL CHART //////////////////////////////////////////////////////
         var yearSlice = []
         if (d3.select("#visual4 #sort").property("checked")){
            value = "std"
          }else{
            value = "value"
          }
          
                                        ///////////////////////// Checkbox //////////////////////
            d3.select("#visual4 #selectedCountries").on("change",update_checkbox);
            
            function update_checkbox() {
                if (d3.select("#visual4 #selectedCountries").property("checked")){
                    d3.select("#visual4 #dropDiv").classed("hidden", false)
                }else{
                    d3.select("#visual4 #dropDiv").classed("hidden", true)
                }
            }
            update_checkbox()

                                    ///////////////////////// DROPDOWN //////////////////////
          yearSlice = data.filter(d => d.year == year && !isNaN(d[value]) && d.name != Global)
                .sort((a,b) => b[value] - a[value])
            
            country = yearSlice.map(d => d.name)
            var countryAlph = yearSlice.map(d => d.name).sort(d3.ascending)
            
            var dropDiv = d3.select("#visual4 #dropDiv")
              .style("width", '100%')
              .style("height", '60px')
              .style("margin-top", '15px');
          
            var selectedCountries = []
            for(var i=0; i<top_n; i++){
                var selector = dropDiv
                    .append("select")
                    .attr("id","dropdown"+i)
                    .style("border", "1px")
                    .style("border-style", "outset")
                    
                if (i==0){
                    var firstRows = [" ", Global]
                }else{
                    var firstRows = [" "]
                }
                
                selector.selectAll("#visual4 option")
                    .data(firstRows)
                    .enter()
                    .append("option")
                    .attr("value", function(d){
                        return d;
                        })
                    .text(function(d){
                        return d;
                        })
                        
                selector.selectAll("#visual4 option")
                    .data(countryAlph)
                    .enter()
                    .append("option")
                    .attr("value", function(d){
                        return d;
                        })
                    .text(function(d){
                        return d;
                        })

                selector.property('value',country[i])
            }
            
            dropDiv.append("br")
            dropDiv.append("br")
            
                                        ///////////////////////// Top / Clear Buttons //////////////////////
            var yearSliceReal = yearSlice.slice(0,top_n)

            dropDiv
                    .append("button")
                    .attr("class", "myButton")
                    .text("Top "+top_n)
                    .on("click", function() {
                        var i = 0
                        d3.selectAll("#visual4 select").property('value',' ')
                        yearSliceReal.forEach(function (n) {
                                d3.select("#visual4 #dropdown"+i).property("value", n.name)
                            i = i + 1
                        })
                        if (!moving) {
                            movingStart()
                        }
                      })
                      
            dropDiv
                    .append("button")
                    .attr("class", "myButton")
                    .text("Clear")
                    .on("click", function() {
                        d3.selectAll("#visual4 select").property('value',' ')
                        movingStop()
                        clear = true
                        if (init == 0) {update(xx.invert(currentValue))} else{update(xx.invert(currentValue)-1)}
                      })
                
          if (d3.select("#visual4 #selectedCountries").property("checked")){
                selectedCountries = []
                    for(var i=0; i<top_n; i++){
                        selectedCountries.push(d3.select("#visual4 #dropdown"+i).property("value"))
                    }
                yearSlice = data.filter(d => d.year == year && !isNaN(d[value]) && !(selectedCountries.indexOf(d.name)===-1))
                    .sort((a,b) => b[value] - a[value])
                    .slice(0,top_n);
            }else{
              yearSlice = data.filter(d => d.year == year && !isNaN(d[value]) && d.name != Global)
                .sort((a,b) => b[value] - a[value])
                .slice(0,top_n);
            }
          
        yearSlice.forEach((d,i) => d.rank = i);

        var ySt = d3.scaleBand()
            .range([visual4Height-sotaMargin.bottom, sotaMargin.top])
        
        ySt.domain(yearSlice.map(d => d.name))
            .padding(0.1)     
     
         let x = d3.scaleLinear()
            .domain([0, d3.max(yearSlice, d => d[value])])
            .range([sotaMargin.left, visual4Width-sotaMargin.right]);
      
         let y = d3.scaleLinear()
            .domain([top_n, 0])
            .range([visual4Height-sotaMargin.bottom, sotaMargin.top]);
      
         let xAxis = d3.axisTop()
            .scale(x)
            .ticks(visual4Width > 500 ? 5:2)
            .tickSize(-(visual4Height-sotaMargin.top-sotaMargin.bottom))
            .tickFormat(d => d);
      
         visual4svg.append('g')
           .attr('class', 'axis xAxis')
           .attr('transform', `translate(0, ${sotaMargin.top})`)
           .call(xAxis)
           .selectAll('#visual4 .tick line')
           .classed('origin', d => d == 0);
           
                                ////////////////////////////////// Stacked Bars /////////////////////////////////////////
            var group = visual4svg.selectAll("#visual4 g.layer")
                .data(d3.stack().keys(category)(yearSlice), d => d.key)

            group.exit().remove()

            group.enter().append("g")
                .classed("layer", true)
                .attr("id", d => d.key)
                .attr("fill", d => z(d.key));
                
        var bars = visual4svg.selectAll("#visual4 g.layer").selectAll("#visual4 rect")
                .data(d => d, e => e.data.name)
                
        bars.exit().remove()
            
            bars.enter().append("rect")
                .attr("id", d => d.data.name)
                .attr("height", ySt.bandwidth())
                .merge(bars)
                    .attr("x", d => x(d[0]))
                    .attr('y', d => y(d.data.rank)+5)
                    .attr("width", d => x(d[1]) - x(d[0]))
                    
                                    ///////////////////////////// Bars Labels ////////////////////////////////
        visual4svg.selectAll('#visual4 text.valueLabel')
          .data(yearSlice, d => d.name)
          .enter()
          .append('text')
          .attr('class', 'label')
            .attr('x', d => x(d[value])+5)
          .attr('y', d => y(d.rank)+5+((y(1)-y(0))/2)+1)
          .text(d => d.name + " | " + d[value] + " | " + d.totalRecord); 

        let yearText = visual4svg.append('text')
          .attr('class', 'yearText')
          .attr('x', visual4Width-sotaMargin.right)
          .attr('y', visual4Height-50)
          .style('text-anchor', 'end')
          .html(~~year)
          
                                ///////////////////////////// SLIDER ////////////////////////////////
        var startDate = year
        var endDate = lastYear

        var marginSlider = {top:40, right:50, bottom:0, left:50},
            widthSlider = visual4Width - marginSlider.left - marginSlider.right,
            heightSlider = 60 - marginSlider.top - marginSlider.bottom;

        var svgSlider = d3.select("#visual4 #sliderSvg")
            .attr("width", widthSlider + marginSlider.left + marginSlider.right)
            .attr("height", heightSlider + marginSlider.top + marginSlider.bottom);  
        
        var moving = false;
        var currentValue = 0;
        var targetValue = widthSlider;
        
        var playPause = d3.selectAll("#visual4 .playpause")
        var playButton = d3.select("#visual4 .button");

        playPause
            .on("click", function() {
                if (playButton.classed("paused")) {movingStop()}else{movingStart()}
          })
          
        function movingStart() {
            playButton.classed("paused", true)
                      moving = true;
                      if (init == 1) {currentValue = currentValue - (targetValue/rangeYear)} else{currentValue = currentValue + (targetValue/rangeYear)}
                      step()
                      timer = setInterval(step, tickDuration);
                      init = 1
        }
        
        function movingStop() {
                    playButton.classed("paused", false)
                    moving = false;
                  if (init == 1) {clearInterval(timer);}
        }
        
        var xx = d3.scaleLinear()
            .domain([startDate, endDate])
            .range([0, targetValue])
            .clamp(true);
            
        var slider = svgSlider.append("g")
            .attr("class", "slider")
            .attr("transform", "translate(" + marginSlider.left + "," + heightSlider + ")");

        slider.append("line")
            .attr("class", "track")
            .attr("transform", "translate(0," + 15 + ")")
            .attr("x1", xx.range()[0])
            .attr("x2", xx.range()[1])
          .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
            .attr("class", "track-inset")
          .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
            .attr("class", "track-overlay")
            .call(d3.drag()
                .on("start.interrupt", function() { slider.interrupt(); })
                .on("start drag", function() {
                  currentValue = d3.event.x;
                  update(xx.invert(currentValue)); 
                })
            );

        slider.insert("g", ".track-overlay")
            .attr("class", "ticks")
            .attr("transform", "translate(0," + 30 + ")")
          .selectAll("#visual4 text")
            .data(xx.ticks(rangeYear))
            .enter()
            .append("text")
            .attr("x", xx)
            .attr("y", 10)
            .attr("text-anchor", "middle")
            .text(function(d) { return d; });

        var handle = slider.insert("circle", ".track-overlay")
            .attr("transform", "translate(0," + 15 + ")")
            .attr("class", "handle")
            .attr("r", 9);

        var label = slider.append("text")  
            .attr("class", "label")
            .attr("text-anchor", "middle")
            .text(startDate)
            .attr("transform", "translate(0," + 0 + ")")

        function step() {
          update(xx.invert(currentValue));

          if (Math.round(xx.invert(currentValue)) >= lastYear) {
            moving = false;
            currentValue = 0;
            clearInterval(timer);
            d3.select("#visual4 .button").classed("paused", false)
          }else{
            currentValue = currentValue + (targetValue/rangeYear);
            }
        }
        
        
    /////////////////////////////////////////////////////////////////////// UPDATE ////////////////////////////////////////////////////////
        function update(h) {
            var a = 0
            for(var i=0; i<top_n; i++){
                if (d3.select("#visual4 #dropdown"+i).property("value") !== " ") {a = 1}
            }
            if (a == 0) {movingStop()}
            if (a == a) { 
                clear = false
                h = d3.format(".0f")(h)
                handle.attr("cx", xx(h));
                label
                    .attr("x", xx(h))
                    .text(h);

                year = h
                
                if (d3.select("#visual4 #sort").property("checked")){
                    value = "std"
                  }else{
                    value = "value"
                  }
                  
                yearSliceReal = data.filter(d => d.year == year && !isNaN(d[value]) && d.name != Global)
                    .sort((a,b) => b[value] - a[value])
                    .slice(0,top_n);

                if (d3.select("#visual4 #selectedCountries").property("checked")){
                    selectedCountries = []
                        for(var i=0; i<top_n; i++){
                            selectedCountries.push(d3.select("#visual4 #dropdown"+i).property("value"))
                        }
                    yearSlice = data.filter(d => d.year == year && !isNaN(d[value]) && !(selectedCountries.indexOf(d.name)===-1))
                        .sort((a,b) => b[value] - a[value])
                        .slice(0,top_n);
                }else{
                  yearSlice = data.filter(d => d.year == year && !isNaN(d[value]) && d.name != Global)
                    .sort((a,b) => b[value] - a[value])
                    .slice(0,top_n);
                }

              yearSlice.forEach((d,i) => d.rank = i);

              x.domain([0, d3.max(yearSlice, d => d[value])]); 

              visual4svg.select('#visual4 .xAxis')
                .transition()
                .duration(tickDuration)
                .ease(d3.easeLinear)
                .call(xAxis);
                
            var group = visual4svg.selectAll("#visual4 g.layer")
                    .data(d3.stack().keys(category)(yearSlice), d => d.key)
                    
                group.exit().remove()

                group.enter().append("g")
                    .classed("layer", true)
                    .attr("id", "d => d.key")
                    .attr("fill", d => z(d.key));
                    
            var bars = visual4svg.selectAll("#visual4 g.layer").selectAll("#visual4 rect")
                    .data(d => d, e => e.data.name)
        
           bars //adding
            .enter()
            .append('rect')
            .attr("id", d => d.data.name)
            .attr("height", ySt.bandwidth())
            .attr("x", d => x(d[0]))
            .attr('y', d => y(top_n+1)+5)
            .attr("width", d => x(d[1]) - x(d[0]))
            .merge(bars)
            .transition()
              .duration(tickDuration)
              .ease(d3.easeLinear)
              .attr('y', d => y(d.data.rank)+5);
              
           bars //changing
            .transition()
              .duration(tickDuration)
              .ease(d3.easeLinear)
            .attr("x", d => x(d[0]))
              .attr("width", d => x(d[1]) - x(d[0]))
              .attr('y', d => y(d.data.rank)+5);
                
           bars  //removing
            .exit()
            .transition()
              .duration(tickDuration)
              .ease(d3.easeLinear)
              .attr('y', d => y(top_n+1)+5)
              .remove();
             
           let valueLabels = visual4svg.selectAll('#visual4 .label').data(yearSlice, d => d.name);
        
           valueLabels
              .enter()
              .append('text')
              .attr('class', 'label')
              .attr('x', d => x(d[value])+5)
              .attr('y', d => y(top_n+1)+5)
              .text(d => d.name + " | " + d[value] + " | " + d.totalRecord)
              .transition()
                .duration(tickDuration)
                .ease(d3.easeLinear)
                .attr('y', d => y(d.rank)+5+((y(1)-y(0))/2)+1);
                
           valueLabels
              .transition()
                .duration(tickDuration)
                .ease(d3.easeLinear)
                .attr('x', d => x(d[value])+5)
                .attr('y', d => y(d.rank)+5+((y(1)-y(0))/2)+1)
                .tween("text", function(d) {
                    var node = this;
                    var text = node.textContent.split( ' | ' );
                   let i = d3.interpolateRound(text[1], d[value]);
                   let j = d3.interpolateRound(text[2], d.totalRecord);
                   return function(t) {
                     node.textContent = text[0] + " | " + i(t) + " | " + j(t); //d3.format(',')(i(t))
                     
                  };
                });
          
          valueLabels
            .exit()
            .transition()
              .duration(tickDuration)
              .ease(d3.easeLinear)
              .attr('y', d => y(top_n+1)+5)
              .remove();
        
          yearText.html(~~year);
       }
       }
     });
    </script>
    <!-- Visual 4 End -->




    <!-- Visual 6 -->
    <script>
        var visual6width = 700, visual6height = 700, visual6widthTable = 250
            
        var visual6svg = d3.select("#visual6 #chartDiv").append("svg")
            .attr("width", visual6width)
            .attr("height", visual6height)
            
        d3.select("#visual6 #tableDiv")
            .style("height", visual6height-70+"px")
            .style("width", visual6widthTable+"px")
        
        var Duration = 500
        var worldY = 80
        const forceStrengthInitial = 0.03;
        const forceStrength = 0.2;
        
        // charge is dependent on size of the bubble, so bigger towards the middle
        function charge(d) {
            return Math.pow(d.radius, 2.0) * 0.01
        }
        
        // create a force simulation and add forces to it
        const simulation = d3.forceSimulation()
            .force('charge', d3.forceManyBody().strength(charge))
            .force('x', d3.forceX().strength(forceStrengthInitial).x(visual6width * .5))
            .force('y', d3.forceY().strength(forceStrengthInitial)
                .y(d => (d.group == "World") ? worldY : visual6height * .5))
            .force('collision', d3.forceCollide().radius(d => d.radius + 1));

        // force simulation starts up automatically, which we don't want as there aren't any nodes yet
        simulation.stop();
        
        var color = d3.scaleOrdinal(["#66c2a5", "#fc8d62", "#8da0cb", "#e78ac3", "#a6d854", "#c9fdff"]); //, "#e5c494", "#b3b3b3"]);
    
        d3.queue()
            .defer(d3.csv, "{% static "issf_base/csv/whos_who.csv" %}")
            .await(ready);

            function ready(error, data) {
            
                data = data.filter(function(d){return d.country__short_name != ''});
        
                data_who_country = d3.nest()
                    .key(function(d) { return d.country__short_name})
                    .rollup(function(v) { return {
                        length: v.length
                    }; })
                    .entries(data);
                
                var new_data = []
                
                data_who_country.forEach(function (d) {
                    
                    var data_country_filtered = data.filter(m => (m.country__short_name == d.key))
                    var region = d3.map(data_country_filtered, function(c){return c.region;}).keys()[0]
            
                    new_data.push({Name: d.key, radius: d.value.length, group: region})
                })

                var Regions1 = ["Latin America & the Caribbean", "Europe"] //, "North America & Canada"
                var Regions2 = [ "Africa", "Asia & Oceania" ]
                
                new_data.forEach(function (d) {
                    d.vert = ((Regions1.indexOf(d.group) === -1) ? 2 : 1)
                    d.count = +d.radius
                })
                
                nodes = new_data

                var min = d3.min(nodes, d=>d.radius)
                var max = d3.max(nodes, d=>d.radius)
                var sum = d3.sum(nodes, d=>d.radius)
                var groups = d3.map(nodes, d=>d.group).keys()
                
                nodes.push({Name: "World", group: "World", radius: 70, vert: 1})
                
                var groupClass = d3.scaleOrdinal()
                    .domain(["Africa", "Europe", "North America & Canada", "Latin America & the Caribbean", "Asia & Oceania", "World"])
                    .range(["Africa", "Europe", "America", "Latin", "Asia", "World"]);
                
                var worldRadius = (visual6height/2)*.85
                
                var radiusScale = d3.scaleLinear()
                    .domain([min, max, sum])
                    .range([26, 70, worldRadius]);
            
                var visual6svg = d3.select('#visual6 svg')  
                
                ///////////////////////////////////////////REGION LEGENDS///////////////////////////////////////////
                groups.sort(d3.ascending).push("World")
                var barMargin = 270
                var bars = visual6svg.selectAll("rect")
                    .data(groups)
        
                bars.enter().append("rect")
                    .attr("id", d => d)
                    .attr("height", 20)
                    .attr("cursor", "pointer")
                    .merge(bars)
                    .attr('x', (d,i)=> 0)
                    .attr('y', (d,i)=> (i <= 2) ? 5 : 30)
                    .attr("width", 20)
                    .attr("fill", d=> color(d))
                    .on("mouseover", function(d) { 
                            if (d!="World"){
                                circles.attr("opacity", d=> d.group == "World" ? 0 : 0.2)
                                lables.attr("opacity", d=> d.group == "World" ? 0 : 0.2)
                                countLables.attr("opacity", d=> d.group == "World" ? 0 : 0.2)
                                d3.selectAll("."+groupClass(d))
                                    .attr("opacity", d=> d.group == "World" ? 0 : 1)
                            }
                        }) 
                    .on("mouseout", function() { 
                            circles.attr("opacity", d=> d.group == "World" ? 0 : 1)
                            lables.attr("opacity", d=> d.group == "World" ? 0 : 1)
                            countLables.attr("opacity", d=> d.group == "World" ? 0 : 1)
                        })
                    .on("click", function () {
                            var country = d3.select(this).attr("id")
                            if (country == "World"){
                                var tableData = data
                                .sort((a,b) => b.number_publications - a.number_publications)
                            }else{
                                var tableData = data.filter(d => d.region == country)
                                    .sort((a,b) => b.number_publications - a.number_publications)
                            }
                            updateTable(tableData, country)
                        })
                    .transition()
                    .ease(d3.easeLinear)
                    .delay(0)
                    .duration(1000)
                        .attr('x', (d,i)=> (i <= 2) ? i*barMargin : i*barMargin-barMargin*3)
                        
                    
                var titles = visual6svg.selectAll('.title')
                        .data(groups)
                    
                titles.enter().append('text')
                    .attr('class', 'title')
                    .attr("text-anchor", "start")
                    .attr("font-family", "sans-serif")
                    .style("font-size", "15px")
                    .attr('x', (d,i)=> (i <= 2) ? i*barMargin+25 : i*barMargin+25-barMargin*3)
                    .attr('y', (d,i)=> (i <= 2) ? 20 : 45)
                    .text(d=>d)
                    .style('opacity', 0.0)
                    .transition()
                    .ease(d3.easeLinear)
                    .delay(500)
                    .duration(2000)
                        .style('opacity', 1.0)
                
                ///////////////////////////////////////////WORLD CIRCLE///////////////////////////////////////////
                d3.selection.prototype.moveToBack = function() {
                    return this.each(function() { 

                        var firstChild = this.parentNode.firstChild; 
                        if (firstChild) { 
                            this.parentNode.insertBefore(this, firstChild); 
                        } 
                    });
                };
                
                var world = visual6svg.append("g")
                    .attr("transform", function(d) {
                            return "translate("+visual6width/2+","+visual6height/2+")";
                            })
                    .attr("class", "world circle")
                    .data(["World"])
                
                world.append("circle")
                    .attr("id", "World")
                    .attr("r", radiusScale(sum))
                    .attr("fill", "#c9fdff")
                    .on("click", mouseClick)
                
                var worldText = world.append("text")
                    .attr("id", "World")
                    .attr("text-anchor", "middle")
                    .attr("font-family", "sans-serif")
                    .text(function(d) {
                            return d;
                        })
                    .attr("font-size", 20)
                    .attr('x', 0)
                    .attr('y', 20-worldRadius)
                    .on("click", mouseClick);
            
                var worldCount = world.append("text")
                    .attr("id", "World")
                    .attr("text-anchor", "middle")
                    .attr("font-family", "sans-serif")
                    .attr("font-size", 20)
                    .text(sum)
                    .attr('x', 0)
                    .attr('y', 40-worldRadius)
                    .on("click", mouseClick);
                
                world.moveToBack();
                
                ///////////////////////////////////////////COUNTRY CIRCLES///////////////////////////////////////////
                function createNodes(rawData) {
                    // use map() to convert raw data into node data
                    const myNodes = rawData.map(d => ({
                        ...d,
                        radius: radiusScale(+d.radius),
                        x: (d.group == "World") ? visual6width/2 : Math.random() * visual6width,
                        y: (d.group == "World") ? worldY : (Math.random() * (1 - .1) + .1) * visual6height
                    }))
                    return myNodes;
                }

                nodes = createNodes(nodes);         
                var node = visual6svg.append("g")
                    .attr("class", "nodes circle")
                    .selectAll("g")
                    .data(nodes)
                    .enter().append("g")
            
                var circles = node.append("circle")
                    .attr("class", d=> groupClass(d.group))
                    .attr("id", d=> d.Name)
                    .attr("opacity", d=> (d.group == "World") ? 0 : 1)
                    .style("pointer-events", d=> (d.group == "World") ? "none" : "")
                    .attr("r", d=>d.radius)
                    .attr("fill", d=> color(d.group))
                    .on("click", mouseClick)
                    
                var lables = node.append("text")
                    .attr("class", d=> groupClass(d.group))
                    .attr("id", d=> d.Name)
                    .attr("opacity", d=> (d.group == "World") ? 0 : 1)
                    .style("pointer-events", d=> (d.group == "World") ? "none" : "")
                    .attr("text-anchor", "middle")
                    .attr("font-family", "sans-serif")
                    .text(function(d) {
                            return d.Name;
                        })
                    .attr("font-size", function(d){
                            return (d.Name == "United Kingdom") ? d.radius/4 : 
                                (d.Name == "Trinidad and Tobago") ? d.radius/5 :
                                (d.Name == "Dem. Rep. Korea") ? d.radius/4.5 :
                                d.radius/3; 
                        })
                    .attr('x', 0)
                    .attr('y', 0)
                    .on("click", mouseClick);
            
                var countLables = node.append("text")
                    .attr("class", d=> groupClass(d.group))
                    .attr("id", d=> d.Name)
                    .attr("opacity", d=> (d.group == "World") ? 0 : 1)
                    .style("pointer-events", d=> (d.group == "World") ? "none" : "")
                    .attr("text-anchor", "middle")
                    .attr("font-family", "sans-serif")
                    .attr("font-size", function(d){
                            return (d.Name == "United Kingdom") ? d.radius/4 : d.radius/3;
                        })
                    .text(d=> d.group == "World" ? sum : d.count)
                    .attr('x', 0)
                    .attr('y', d=>d.radius/2)
                    .on("click", mouseClick);
                
                function mouseClick(d) {
                    var country = d3.select(this).attr("id")
                    if (country == "World"){
                        var tableData = data
                        .sort((a,b) => b.number_publications - a.number_publications)
                    }else{
                        var tableData = data.filter(d => d.country__short_name == country)
                            .sort((a,b) => b.number_publications - a.number_publications)
                    }
                    updateTable(tableData, country)
                }
                
                simulation.nodes(nodes)
                    .on('tick', ticked)
                    .restart();
                ///////////////////////////////////////////PUBLICATIONS TABLE///////////////////////////////////////////
                var legend = d3.select("#tableDiv")
                    .append("table").attr('id','publications').attr("width", "100%")
                    
                var header = legend.append("thead");
                
                var headerCountry = header.append("tr")
                    .selectAll("th")
                    .data(["World ("+sum+")"])
                    .enter()
                    .append("th")
                    .attr("class", "headerCountry")
                    .style("font-size", "18px")
                    .attr("align", "center")
                    .attr("colspan", 3)
                    .text(d=>d);
                    
                header.append("tr")
                    .selectAll("th")
                    .data(["Researchers"])
                    .enter()
                    .append("th").attr("width", "10%")
                    .attr("align", "middle")
                    .style("font-size", "15px")
                    .attr("colspan", 2)
                    .text(d=>d);
                

                
                var tableData = data
                    .sort((a,b) => b.number_publications - a.number_publications)
                
                var tr = legend.append("tbody").selectAll("tr")
                    .data(tableData).enter().append("tr");

                // create the first column for each segment.
                tr.append("td").append("svg").attr("width", '12').attr("height", '12').append("rect")
                    .attr("width", '12').attr("height", '12')
                    .attr("fill",d=> color(d.region));

                // create the second column for each segment.
                tr.append("td")
                    .attr("class",'legendPublisher')
                    .attr("font-family", "sans-serif")
                    .style("font-size", "15px")
                    .style("width", "150px")
                    .text(d=> d["core_record_summary"]);

                function updateTable(tableData, country) {
                    headerCountry.text(country+" ("+tableData.length+")")
                    var tr = legend.select("tbody").selectAll("tr")
                    
                    tr.remove();
                    
                    var tr = legend.select("tbody").selectAll("tr").data(tableData)
                    
                    var trEnter = tr.enter().append("tr");
                    
                    trEnter.append("td").append("svg").attr("width", '12').attr("height", '12').append("rect")
                        .attr("width", '12').attr("height", '12')
                        .attr("fill",d=> color(d.region))
                        
                    trEnter.append("td")
                        .attr("class",'legendPublisher')    
                        .attr("font-family", "sans-serif")
                        .style("font-size", "15px")
                        .style("width", "150px")
                        .text(d=> d["core_record_summary"])
                    
                    trEnter
                        .style('opacity', 0.0)
                        .transition()
                        .delay(500)
                        .duration(0)
                            .style('opacity', 1.0);
                }               
                
                ///////////////////////////////////////////SIMULATIONS///////////////////////////////////////////
                function ticked() {
                    node
                        .attr("transform", function(d) {
                            return "translate(" + d.x + "," + d.y + ")";
                            })
                }
                
                var padding = .4
                var paddingY = .6
                
                var centerScaleX1 = d3.scalePoint().padding(padding).range([0, visual6width]);
                var centerScaleX2 = d3.scalePoint().padding(padding).range([0, visual6width]);
                var centerScaleY = d3.scalePoint().padding(paddingY).range([0, visual6height]);
                
                function splitBubbles(byVar) {
                    centerScaleX1.domain(Regions1);
                    centerScaleX2.domain(Regions2);
                    centerScaleY.domain([1,2]);
                    
                    lables.attr("opacity", d=>d.group == "World" ? 0 : 1)
                    countLables.attr("opacity", d=>d.group == "World" ? 0 : 1)
                    worldText.attr("opacity", 1)
                    worldCount.attr("opacity", 1)
                    
                    if(byVar == "all"){
                    
                        simulation
                            .force('forceX', d3.forceX().strength(forceStrengthInitial).x(visual6width/2))
                            .force("forceY", d3.forceY().strength(forceStrengthInitial)
                            .y(d=> (d.group == "World") ? worldY : visual6height * .5))
                            .alpha(1).restart();
                    } else {
                        simulation
                            .force('forceX', d3.forceX().strength(forceStrength)
                                .x(d=> (d.group == "North America & Canada" || d.group == "World") ? visual6width * .5 : (d.vert == 1) ? centerScaleX1(d.group) : centerScaleX2(d.group))
                                )
                            .force('forceY', d3.forceY().strength(forceStrength)
                                .y(d=> (d.group == "World") ? worldY : (d.group == "North America & Canada") ? visual6height * .5 : centerScaleY(d.vert))
                                )
                            .alpha(1).restart();
                    }
                }
                
                function setupButtons() {
                    d3.selectAll('.button')
                        .on('click', function () {
                            d3.selectAll('.button').classed('active', false);
                            var button = d3.select(this);
                            button.classed('active', true);
                            var buttonId = button.attr('id');
                            splitBubbles(buttonId);
                        });
                }
                
                setupButtons()
            }
    </script>
    <!-- Visual 6 end -->




    <!-- Visual 7 -->
    <script>
        var visual7Width = 700;
        var visual7Height = 500;
        var marginV = 20;
        var marginH = 30;
        var duration = 250;
        
        var pieDim ={w:200, h: visual7Height+marginV};
        pieDim.r = Math.min(pieDim.w, pieDim.h) / 2;

        var lineOpacity = ".5";
        var otherLinesOpacityHoverRegion = ".4";
        var lineOpacityHover = "1";
        var otherLinesOpacityHover = "0.1";
        var lineStroke = "1.5px";
        var lineStrokeHover = "2.5px";

        var circleOpacity = '1';
        var circleOpacityOnLineHover = "0.25"
        var circleRadius = 3;
        var circleRadiusHover = 6;
        
        xTick = 10;
        yTick = 3
        
        var lock = d3.select("#visual7-lockCheckbox").property("checked") ? 1 : 0

        d3.queue()
            .defer(d3.csv, "{% static "issf_base/csv/sota2.csv" %}")
            .await(ready);

        function ready(error, sota) { 
            var form_val = "total"
            
            /////////////////////////////////////////// DATA ///////////////////////////////////////////
            sota = sota.filter(function(d){return d.country != '' && d.country != '0' && d.year>=1000});
            
            var uniqueCountryArray = d3.map(sota, d => d.country).keys().sort(d3.ascending)
            
            var type = d3.map(sota, d => d.theme_issue_category).keys().sort(d3.ascending)

            var regions = d3.map(sota, d => d.region).keys()
            
            data_sota_country = d3.nest()
                .key(function(d) { return d.country}).sortKeys(d3.ascending)
                .key(function(d) { return d.year}).sortKeys(d3.ascending)
                .rollup(function(v) { return {
                    total: v.length
                }; })
                .entries(sota);
            
            data_sota_region = d3.nest()
                .key(function(d) { return d.region}).sortKeys(d3.ascending)
                .rollup(function(v) { return {
                    total: v.length
                }; })
                .object(sota);
                
            regions.forEach (function(d) {
                var data_regions_filtered = sota.filter(m => (m.region == d))
                var records = d3.map(data_regions_filtered, m=> m.issf_core_id).keys().length
                data_sota_region[d].record = records
            })
            
            var Global = "Global Data"

            var new_data = []
            data_sota_country.forEach(function (d,i) {
                var data_country_filtered = sota.filter(m => (m.country == d.key))
                var region = d3.map(data_country_filtered, m=>m.region).keys()[0]
                new_data.push({name: d.key, region: region, values: []})
                d.values.forEach(function (v) {
                    var data_year_filtered = data_country_filtered.filter(m => (m.year == v.key))
                    var records = d3.map(data_year_filtered, m=> m.issf_core_id).keys().length
                    new_data[i].values.push({date: v.key, total: v.value[form_val], name: d.key, record: records, region: region})
                })
            })

            pD = d3.nest()
                .key(function(d) { return d.theme_issue_category}).sortKeys(d3.ascending)
                .rollup(function(v) { return {
                    total: v.length
                }; })
                .entries(sota);

            pD.forEach(function(d){
                var sota_filtered = sota.filter(m => (m.theme_issue_category == d.key))
                var count_issf = d3.map(sota_filtered, d => d.issf_core_id).keys().length
                d.value.record = count_issf
            })
        
            data = new_data

            maxValue = d3.max(data, d => d3.max(d.values, v => v[form_val]))
            
            minValue = d3.min(data, d => d3.min(d.values, v => v[form_val]))

            /////////////////////////////////////////// lineChart ///////////////////////////////////////////
            var xScale = d3.scaleLinear()
            .domain(d3.extent(sota, d => d.year))
            .range([0, visual7Width-marginH]);
            
            if (form_val=="total"){
                var yScale = d3.scaleLog()
                    .domain([1, maxValue])
                    .range([visual7Height-marginV, 0])
            }else{
                var yScale = d3.scaleLinear()
                    .domain([0, maxValue])
                    .range([visual7Height-marginV, 0]);
            }

            var color = d3.scaleOrdinal(d3.schemeCategory20);

            var svg = d3.select("#visual7-chart").append("svg")
                .attr("width", (visual7Width+marginH)+"px")
                .attr("height", (visual7Height+marginV)+"px")
                .append('g')
                .attr("transform", `translate(${marginH}, ${marginV})`);
                
            svg.append("text")
                        .attr("class", "title-text")
                        .style("font-size", "18px")
                        .style("fill", "black") //d3.rgb(color(i)).darker(10))
                        .text(Global + " | Themes (" + sota.length + ")"+ " | Records (" + d3.map(sota, d => d.issf_core_id).keys().length + ")")
                        .attr("text-anchor", "middle")
                        .attr("x", (visual7Width-marginH)/2)
                        .attr("y", 5);

            var line = d3.line()
                .x(d => xScale(d.date))
                .y(d => yScale(d[form_val]));

            let lines = svg.append('g')
                .attr('class', 'lines');

            lines.selectAll('#visual7 .line-group')
                .data(data).enter()
                .append('g')
                    .attr('class', 'line-group')
                    .style("cursor", "pointer")
                    .on("mouseover", function(d, i) {
                        var selected_init = d3.select('#visual7-dropdown option:checked').text()
                        if (lock == 0 || (d.name == selected_init) || (regions.indexOf(selected_init) != -1)){  
                            var total = d3.sum(d.values, t => t[form_val])
                            var record = d3.sum(d.values, t => t.record)
                            
                            svg.select("#visual7 .title-text").remove();
                                
                            svg.append("text")
                            .attr("class", "title-text")
                            .style("font-size", "18px")
                            .style("fill", "black")
                            .text(d.name + " | Themes (" + total + ")"+ " | Records (" + record + ")")
                            .attr("text-anchor", "middle")
                            .attr("x", (visual7Width-marginH)/2)
                            .attr("y", 5);
                        }
                    })
                .append('path')
                    .attr('id', d => d.name.replace(/ /g, "_").replace(/\(/g, "_").replace(/\)/g, "_").replace(/'/g, "_").replace(/\./g, "_"))
                    .attr('class',d=> 'line ' + d.region.replace(/ /g, "_").replace(/&/g, "_"))
                    .attr('d', d => line(d.values))
                    .style('stroke', (d, i) => color(i))
                    .style('opacity', lineOpacity)
                    .on("mouseover", function(d) {
                        var selected_init = d3.select('#visual7-dropdown option:checked').text()
                        var selected = d3.select('#visual7-dropdown').property('value')
                        if (regions.indexOf(selected_init) != -1 && lock ==1){
                            
                            
                            d3.selectAll("#visual7 ."+selected)
                                .style('opacity', otherLinesOpacityHoverRegion)
                                .style("stroke-width", lineStrokeHover)
                                
                            d3.selectAll("#visual7 .c"+selected).style('opacity', otherLinesOpacityHoverRegion)
                            
                            d3.select(this)
                                .transition()
                                .duration(duration)
                                .style('stroke-width', "3.5")
                                .style('opacity', 1)
                                
                            d3.selectAll("#visual7 #c"+this.id).style('opacity', 1)
                        }   
                        if (lock == 0 || (d.name == selected_init)){onchange(this.id, "all")}
                        if (regions.indexOf(selected_init) != -1) {onchangeinregion(this.id, "all")}
                    })
                    .on("click", clicked)
                    
                    function clicked() {
                        if (lock == 0) {
                            lock = 1
                            d3.select("#visual7-lockCheckbox").property('checked', true);
                        }else {
                            lock = 0
                            d3.select("#visual7-lockCheckbox").property('checked', false);
                        }
                        onlockChange()
                    }
            
            let circles = svg.append('g')
                .attr('class', 'circles');
                
            circles.selectAll("#visual7 .circle-group")
                .data(data).enter()
                .append("g")
                    .attr('class', 'circle-group')
                    .attr('id', d => d.name.replace(/ /g, "_").replace(/\(/g, "_").replace(/\)/g, "_").replace(/'/g, "_").replace(/\./g, "_"))
                    .style("fill", (d, i) => color(i))
                    .selectAll("#visual7 circle")
                    .data(d => d.values).enter()
                    .append("g")
                        .attr("class", "circle")
                        .style("cursor", "pointer")
                        .on("mouseover", function(d) {
                            var selected_init = d3.select('#visual7-dropdown option:checked').text()
                            if (lock == 0 || (d.name == selected_init) || (regions.indexOf(selected_init) != -1)){
                                d3.select(this) 
                                    .append("text")
                                    .attr("class", "text")
                                    .text(`${d[form_val]}`)
                                    .attr("x", d => xScale(d.date) + 5)
                                    .attr("y", d => yScale(d[form_val]) - 10);
                                    
                                svg.select("#visual7 .title-text").remove();
                                svg.append("text")
                                .attr("class", "title-text")
                                .style("font-size", "18px")
                                .style("fill", "black")
                                .text(d.name + " | Year: " + d.date +" | Themes ("+ d[form_val] +")"+" | Records ("+ d.record +")")
                                .attr("text-anchor", "middle")
                                .attr("x", (visual7Width-marginH)/2)
                                .attr("y", 5);
                            }
                        })
                        .on("mouseout", function(d) {
                            var selected_init = d3.select('#visual7-dropdown option:checked').text()
                            if (lock == 0 || (d.name == selected_init) || (regions.indexOf(selected_init) != -1)){
                                d3.select(this)
                                    .transition()
                                    .duration(duration)
                                    .selectAll("#visual7 .text").remove();
                            }
                        })
                        .append("circle")
                            .attr("class",d=> "c"+d.region.replace(/ /g, "_").replace(/&/g, "_"))
                            .attr("id", d=> "c"+d.name.replace(/ /g, "_").replace(/\(/g, "_").replace(/\)/g, "_").replace(/'/g, "_").replace(/\./g, "_"))
                            .attr("year", d=> d.date)
                            .attr("cx", d => xScale(d.date))
                            .attr("cy", d => yScale(d[form_val]))
                            .attr("r", circleRadius)
                            .style('opacity', circleOpacity)
                            .on("mouseover", function(d) {
                            var selected_init = d3.select('#visual7-dropdown option:checked').text()
                            var selected = d3.select('#visual7-dropdown').property('value')
                            if (regions.indexOf(selected_init) != -1 && lock ==1){
                                d3.selectAll("#visual7 ."+selected)
                                    .style('opacity', otherLinesOpacityHoverRegion)
                                    .style("stroke-width", lineStrokeHover)
                                    
                                d3.selectAll("#visual7 .c"+selected).style('opacity', otherLinesOpacityHoverRegion)
                            
                                d3.select("#visual7 #"+this.id.slice(1))
                                    .transition()
                                    .duration(duration)
                                    .style('stroke-width', "3.5")
                                    .style('opacity', 1)
                                    
                                d3.selectAll("#visual7 #c"+this.id.slice(1)).style('opacity', 1)
                            }
                        
                            if (lock == 0 || (d.name == selected_init) || (regions.indexOf(selected_init) != -1)){
                                    if (regions.indexOf(selected_init) === -1) {onchange(this.id.slice(1), d.date)}
                                    if (regions.indexOf(selected_init) != -1) {onchangeinregion(this.id.slice(1), d.date)}
                                    d3.select(this)
                                        .transition()
                                        .duration(duration)
                                        .attr("r", circleRadiusHover);
                                }
                            })
                            .on("mouseout", function(d) {
                            var selected_init = d3.select('#visual7-dropdown option:checked').text()
                            
                                    d3.select(this) 
                                        .transition()
                                        .duration(duration)
                                        .attr("r", circleRadius);
                                
                            })
                            .on("click", clicked)

            var xAxis = d3.axisBottom(xScale).ticks(xTick).tickFormat(d3.format(".0f"));
            var yAxis = d3.axisLeft(yScale).ticks(yTick).tickFormat(d3.format(".0f"));

            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", `translate(0, ${visual7Height-marginV})`)
                .call(xAxis)
                .append('text')
                    .attr("x", visual7Width-marginH-15)
                    .attr("y", -5)
                    .attr("transform", "rotate(0)")
                    .attr("fill", "#000")
                    .text("Years");

            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis)
                .append('text')
                    .attr("y", 15)
                    .attr("transform", "rotate(-90)")
                    .attr("fill", "#000")
                    .text("Total themes");
                    
            /////////////////////////////////////////// PIE CHART ///////////////////////////////////////////
                var colorChart = d3.scaleOrdinal()
                    .range(["#0000FF", "#FF4500", "#008000", "#e823d1", "#696969"]);    
                        
                // create svg for pie chart.
                var piesvg = d3.select("#visual7-pieChart")
                .append("svg")
                    .attr("width",pieDim.w).attr("height", pieDim.h)
                        
                // create function to draw the arcs of the pie slices.
                var arc = d3.arc().outerRadius(pieDim.r).innerRadius(pieDim.r/3);

                // create a function to compute the pie slice angles.
                var pie = d3.pie().sort(null).value(function(d) {

                return d.value[form_val]; });

                var pieg = piesvg.append("g")
                        .attr("transform", "translate("+pieDim.w/2+","+(pieDim.h/4)+")")
                        .attr("id", "pie")
                
                pieg.selectAll("#visual7 path")
                    .data(pie(pD))
                    .enter()
                    .append("path")
                        .attr("class", function(d) { return d.data.key; })
                        .attr("d", arc)
                        .each(function(d) { this._current = d; })
                        .style("fill", function(d) { return colorChart(d.data.key); })

                pieg.selectAll("#visual7 .pieText")
                    .data(pie(pD))
                    .enter().append("text")
                    .attr("class", "pieText")
                    .attr("transform", d=> "translate(" + arc.centroid(d) + ")") 
                    .attr('dy', "0.35em")
                    .style("text-anchor", "middle")
                    .text(function(d) {return d.data.value[form_val]; });

            /////////////////////////////////////////// UPDATE PIE CHART///////////////////////////////////////////
            function pieUpdate(nD,single){
                    pieg.selectAll("#visual7 path").data(pie(nD)).transition().duration(700)
                        .attrTween("d", arcTween);
                        
                    pieg.selectAll("#visual7 .pieText").data(pie(nD)).transition().duration(700)
                        .attr("transform", d=> (single == 1) ? "translate("+0+","+0+")" : "translate(" + arc.centroid(d) + ")")
                        .attr("opacity", d=> (d.data.value[form_val] == 0) ? 0 : 1)
                        .text(function(d) { return d.data.value[form_val]; });
                        
                // Animating the pie-slice requiring a custom function which specifies
                function arcTween(a) {
                    var i = d3.interpolate(this._current, a);
                    this._current = i(0);
                    return function(t) { return arc(i(t));    };
                } 
            }
            
            ///////////////////////////////////////////TYPE LEGENDS///////////////////////////////////////////
                var typeg = piesvg.append("g").attr("id", "typeBars")
                    .attr("transform", "translate("+pieDim.w/2+","+(pieDim.h/3 + pieDim.r +10)+")")
                    
                typeg.selectAll("#visual7 rect")
                    .data(type).enter().append("rect")
                    .attr("id", d => d)
                    .attr("height", 20)
                    .attr('x', (d,i)=> -50)
                    .attr('y', (d,i)=> 25)
                    .attr("width", 20)
                    .attr("fill", d=> colorChart(d))
                    .transition()
                    .ease(d3.easeLinear)
                    .delay(0)
                    .duration(700)
                        .attr('y', (d,i)=> (i*25));
                    
                typeg.selectAll('#visual7 .title')
                    .data(type).enter().append('text')
                    .attr('class', 'title')
                    .attr("text-anchor", "start")
                    .attr("font-family", "sans-serif")
                    .style("font-size", "13px")
                    .attr('x', (d,i)=> -25)
                    .attr('y', (d,i)=> (i*25)+15)
                    .text(d=>d)
                    .style('opacity', 0.0)
                    .transition()
                    .ease(d3.easeLinear)
                    .delay(500)
                    .duration(700)
                        .style('opacity', 1.0)
                        
            /////////////////////////////////////////// DROPDOWN ///////////////////////////////////////////
            var selector = d3.select("#visual7_dropdown")
                    .append("select")
                    .attr("id","visual7-dropdown")
                    .style("border-style", "outset")
                    .on("change", function(d) {
                            var selected_init = d3.select('#visual7-dropdown option:checked').text() 
                            var selected = d3.select('#visual7-dropdown').property('value')

                            svg.select("#visual7 .title-text").remove();
                            if (selected_init == Global) {
                                var total = sota.length 
                                var record = d3.map(sota,d=> d.issf_core_id).keys().length
                            }else if (regions.indexOf(selected_init) != -1){
                                var total = data_sota_region[selected_init].total
                                var record = data_sota_region[selected_init].record
                            }
                            else {
                                var total = d3.sum(data.filter(d=>d.name == selected_init)[0].values, v=> v[form_val])
                                var record = d3.sum(data.filter(d=>d.name == selected_init)[0].values, v=> v.record)
                            }
                            svg.append("text")
                                .attr("class", "title-text")
                                .style("font-size", "18px")
                                .style("fill", "black")
                                .text(selected_init + " | Themes ("+ total +")"+ " | Records ("+ record +")")
                                .attr("text-anchor", "middle")
                                .attr("x", (visual7Width-marginH)/2)
                                .attr("y", 5);
                            
                            onlockChange()
                            onchange(selected, "all", selected_init)
                        })
                        
                    function onchangeinregion(selected, year, selected_init) {
                        if (year == "all") {
                                var sotaFiltered = sota.filter(c => c.country.replace(/ /g, "_").replace(/\(/g, "_").replace(/\)/g, "_").replace(/'/g, "_").replace(/\./g, "_") == selected)
                            }else {
                                var sotaFiltered = sota.filter(c => c.year == year && c.country.replace(/ /g, "_").replace(/\(/g, "_").replace(/\)/g, "_").replace(/'/g, "_").replace(/\./g, "_") == selected)
                            }
                            
                            nD = d3.nest()
                                .key(function(d) { return d.theme_issue_category}).sortKeys(d3.ascending)
                                .rollup(function(v) { return {
                                    total: v.length
                                }; })
                                .entries(sotaFiltered);
                                
                            nD.forEach(function(d){
                                var sota_filtered = sota.filter(m => (m.theme_issue_category == d.key && m.country == selected_init))
                                var count_issf = d3.map(sota_filtered, d => d.issf_core_id).keys().length
                                d.value.record = count_issf
                            })
                            
                            var type_current = d3.map(nD, d => d.key).keys()
                            var single = type_current.length
                                
                            //Adding nonExist Types to Country
                            for(var j =0;j<type.length;j++){
                                if (type_current.indexOf(type[j]) === -1){
                    
                                    nD.push({key : type[j], value: {total :0, record:0}}); 
                                }
                            }

                            nD.sort(d3.ascending);

                            pieUpdate(nD,single)
                    }
                    
                    function onchange(selected, year, selected_init) {
                        if (selected == Global.replace(/ /g, "_")){
                            d3.selectAll('#visual7 .line')
                                .style('opacity', lineOpacity);
                            d3.selectAll('#visual7 circle')
                                .style('opacity', circleOpacity);
                            pieUpdate(pD,4)
                        }else if (regions.indexOf(selected_init) != -1){
                            d3.selectAll('#visual7 .line')
                                .style('opacity', otherLinesOpacityHover)
                                .style("stroke-width", lineStroke)
                                
                            d3.selectAll('#visual7 circle')
                                .style('opacity', circleOpacityOnLineHover)
                
                            d3.selectAll("#visual7 ."+selected)
                                .style('opacity', lineOpacityHover)
                                .style("stroke-width", lineStrokeHover)
                                
                            d3.selectAll("#visual7 .c"+selected).style('opacity', 1)
                            
                            var sotaFiltered = sota.filter(c => c.region == selected_init)
                            
                            nD = d3.nest()
                                .key(function(d) { return d.theme_issue_category}).sortKeys(d3.ascending)
                                .rollup(function(v) { return {
                                    total: v.length
                                }; })
                                .entries(sotaFiltered);
                                
                            nD.forEach(function(d){
                                var sota_filtered = sota.filter(m => (m.theme_issue_category == d.key && m.region == selected_init))
                                var count_issf = d3.map(sota_filtered, d => d.issf_core_id).keys().length
                                d.value.record = count_issf
                            })
                            
                            var type_current = d3.map(nD, d => d.key).keys()
                            var single = type_current.length
                                
                            //Adding nonExist Types to Country
                            for(var j =0;j<type.length;j++){
                                if (type_current.indexOf(type[j]) === -1){
                    
                                    nD.push({key : type[j], value: {total :0, record:0}}); 
                                }
                            }

                            nD.sort(d3.ascending);

                            pieUpdate(nD,single)
                        }
                        else {
                        
                            d3.select('#visual7-dropdown').property('value', selected)
                            
                            d3.selectAll('#visual7 .line')
                                .style('opacity', otherLinesOpacityHover)
                                .style("stroke-width", lineStroke)
                                
                            d3.selectAll('#visual7 circle')
                                .style('opacity', circleOpacityOnLineHover)
                                
                            d3.select("#visual7 #"+selected)
                                .style('opacity', lineOpacityHover)
                                .style("stroke-width", lineStrokeHover)
                                
                            d3.selectAll("#visual7 #c"+selected).style('opacity', 1)
                            
                            if (year == "all") {
                                var sotaFiltered = sota.filter(c => c.country.replace(/ /g, "_").replace(/\(/g, "_").replace(/\)/g, "_").replace(/'/g, "_").replace(/\./g, "_") == selected)
                            }else {
                                var sotaFiltered = sota.filter(c => c.year == year && c.country.replace(/ /g, "_").replace(/\(/g, "_").replace(/\)/g, "_").replace(/'/g, "_").replace(/\./g, "_") == selected)
                            }
                            
                            nD = d3.nest()
                                .key(function(d) { return d.theme_issue_category}).sortKeys(d3.ascending)
                                .rollup(function(v) { return {
                                    total: v.length
                                }; })
                                .entries(sotaFiltered);
                                
                            nD.forEach(function(d){
                                var sota_filtered = sota.filter(m => (m.theme_issue_category == d.key && m.country == selected_init))
                                var count_issf = d3.map(sota_filtered, d => d.issf_core_id).keys().length
                                d.value.record = count_issf
                            })
                            
                            var type_current = d3.map(nD, d => d.key).keys()
                            var single = type_current.length
                                
                            //Adding nonExist Types to Country
                            for(var j =0;j<type.length;j++){
                                if (type_current.indexOf(type[j]) === -1){
                    
                                    nD.push({key : type[j], value: {total :0, record:0}}); 
                                }
                            }

                            nD.sort(d3.ascending);

                            pieUpdate(nD,single)
                        }
                    }
                    
            selector 
                .append("optgroup")
                    .attr("label", "Global")
                    .attr("value", "Global")
                .append("option")
                    .attr("value", function(d){
                        return Global.replace(/ /g, "_").replace(/\(/g, "_").replace(/\)/g, "_").replace(/'/g, "_").replace(/&/g, "_").replace(/\./g, "_");
                    })
                    .text(function(d){
                        return Global;
                    })
                    
            selector
                .append("optgroup")
                    .attr("label", "Regions")
                    .attr("value", "Regions")
                .selectAll("#visual7 option")
                .data(regions)
                .enter()
                .append("option")
                    .attr("value", function(d){
                        return d.replace(/ /g, "_").replace(/\(/g, "_").replace(/\)/g, "_").replace(/'/g, "_").replace(/&/g, "_").replace(/\./g, "_");
                    })
                    .text(function(d){
                        return d;
                    })

            selector
                .append("optgroup")
                    .attr("label", "Countries")
                    .attr("value", "Countries")
                .selectAll("#visual7 option")
                .data(uniqueCountryArray)
                .enter()
                .append("option")
                    .attr("value", function(d){
                        return d.replace(/ /g, "_").replace(/\(/g, "_").replace(/\)/g, "_").replace(/'/g, "_").replace(/&/g, "_").replace(/\./g, "_");
                    })
                    .text(function(d){
                        return d;
                    })
            
            /////////////////////////////////////////// lockCheckbox ///////////////////////////////////////////
            d3.select("#visual7-lockCheckbox").on("change", onlockChange)
            
            function onlockChange(){
                var selected = d3.select('#visual7-dropdown').property('value')
                var selected_init = d3.select('#visual7-dropdown option:checked').text()
                lock = 0
                if (d3.select("#visual7-lockCheckbox").property("checked")){
                    lock = 1
                    d3.selectAll('#visual7 .line')
                        .style("pointer-events", "none")
                                
                    d3.selectAll('#visual7 circle')
                        .style("pointer-events", "none")
                        
                    if (regions.indexOf(selected_init) != -1){
                        d3.selectAll("#visual7 ."+selected)
                            .style("pointer-events", "");
                                    
                        d3.selectAll("#visual7 .c"+selected)
                            .style("pointer-events", "")
                    }else{
                                
                        d3.select("#visual7 #"+selected)
                            .style("pointer-events", "");
                                    
                        d3.selectAll("#visual7 #c"+selected)
                            .style("pointer-events", "")
                    }
                }else{
                    d3.selectAll('#visual7 .line')
                        .style("pointer-events", "")
                                
                    d3.selectAll('#visual7 circle')
                        .style("pointer-events", "")
                }               
            };
            onlockChange()
        }
    </script>
    <!-- Visual 7 end -->




    <script type="text/javascript">

        /* Page State */

        var GlobalNewLoad = false;
        var GlobalMapChangeFlag = false;

        if ($("#newload").val().length > 0) {
            // User returned to page using backspace
        } else {
            $('#newload').val(1);
            GlobalNewLoad = true;
        }

        // Caches the filter button states in case user comes back using back button
        function SaveFilterButtonStatus() {
            var indices = "";
            $('.map-icons>a').each(function () {
                if ($(this).hasClass('on')) {
                    indices = indices + $(this).index() + ",";
                }
            });
            if (indices.length > 0) {
                indices = indices.substr(0, indices.length - 1);
            }
            if (typeof(window.localStorage) !== "undefined") {
                localStorage.setItem("filterButtonCache", indices);
            }
        }

        $(document).ready(function () {
            // Save page state
            window.onbeforeunload = function () {
                localStorage.setItem('activetab', $('.tabs>li.active>a').attr('href'));

                if (GlobalMapHandle) {
                    var mapzoom = GlobalMapHandle.getZoom();
                    var mapcenter = JSON.stringify(GlobalMapHandle.getCenter());

                    localStorage.setItem('mapzoom', mapzoom);
                    localStorage.setItem('mapcenter', mapcenter);
                }

                GlobalTableHandle.order([3, 'desc']);

                if (GlobalTableHandle) {
                    var tableorder = JSON.stringify(GlobalTableHandle.order());
                    var tablepage = GlobalTableHandle.page();
                    var recordPerPage = GlobalTableHandle.page.len();
                    localStorage.setItem('tableorder', tableorder);
                    localStorage.setItem('tablepage', tablepage);
                    localStorage.setItem('recordPerPage', recordPerPage);
                }
            };

            $("#quick-country-select").children('select').attr('placeholder', 'Country');

            var quickCountrySelect = $('#quick-country-select').children('select')[0];
            $(quickCountrySelect).removeAttr("multiple");
            $(quickCountrySelect).selectize();
            quickCountrySelect.selectize.clear();
            $('#quick-country-select').show();

            var fullCountrySelectContainer = $('#full-country-select-container').children('select')[0]
            $(fullCountrySelectContainer).selectize();
            fullCountrySelectContainer.selectize.clear();

            /* Restore Page State */

            // Restore tab
            if (localStorage.getItem("activetab") && !GlobalNewLoad) {
                $('.tabs>li>a[href="' + localStorage.getItem("activetab") + '"]').click();
            }

            // Restoration of mapzoom/mapcenter is perform at the end of loadData() -> map loading
            // Restoration of table order/page is perform at the end of loadData() -> table loading

            /* Initialize Perfect Scroll bar on Advanced Search content containers */

            // Prepare Attribute Values dynamically fill select on search form
            var HomepageAdvancedSearchCharacteriscticsAttributeValueCollection = function () {
                this.attributeValueID = [];
                this.attributeID = [];
                this.valueLabel = [];
                this.valueOrder = [];
            };

            window.attributeValues = new HomepageAdvancedSearchCharacteriscticsAttributeValueCollection();

            {% for attribute_value in attribute_values %}
                attributeValues.attributeValueID.push({{ attribute_value.attribute_value_id }});
                attributeValues.attributeID.push({{ attribute_value.attribute.attribute_id }});
                attributeValues.valueLabel.push("{{ attribute_value.value_label }}");
                attributeValues.valueOrder.push({{ attribute_value.value_order }});
            {% endfor %}

            // Home Page advanced search -> characteristics -> select on change handler
            var $select = $('.advancedSearchPanelTab #char-attr select');
            var attrVals = $('.advancedSearchPanelTab #char-attr-val select');

            $select.on('change', function () {
                var val = $(this).val();
                attrVals.empty();
                attributeValues.attributeID.forEach(function (value, i) {
                    if (value == val) {
                        attrVals.append($('<option></option>').attr("value", (attributeValues.attributeValueID[i])).text(attributeValues.valueLabel[i]));
                    }
                });
            });

            var HomepageAdvancedSearchThemeIssueValueCollection = function () {
                this.themeissueValueID = [];
                this.themeissueID = [];
                this.themeissueLabel = [];
                this.themeissueOrder = [];
            };

            window.themeissueValues = new HomepageAdvancedSearchThemeIssueValueCollection();

            {% for theme_issue_value in theme_issue_values %}
                themeissueValues.themeissueValueID.push({{ theme_issue_value.theme_issue_value_id }});
                themeissueValues.themeissueID.push({{ theme_issue_value.theme_issue.theme_issue_id }});
                themeissueValues.themeissueLabel.push("{{ theme_issue_value.theme_issue_label }}");
                themeissueValues.themeissueOrder.push({{ theme_issue_value.label_order }});
            {% endfor %}

            // Home Page advanced search -> themes/issues -> select on change handler
            var $tiSelect = $('.advancedSearchPanelTab #ti-attr select');
            var tiVals = $('.advancedSearchPanelTab #ti-attr-val select');

            $tiSelect.on('change', function () {
                var val = $(this).val();
                tiVals.empty();
                themeissueValues.themeissueID.forEach(function (value, i) {
                    if (value == val) {
                        tiVals.append($('<option></option>').attr("value", (themeissueValues.themeissueValueID[i])).text(themeissueValues.themeissueLabel[i]));
                    }
                });
            });

            $('#quick-reset-button').on('click', function () {
                $('#quick-area').children('input').val('');
                quickCountrySelect.selectize.clear();
                $('.reset-button').trigger('click');
            });

            // Reset themes/issues and attributes in advanced search panel
            $('.reset-button').on('click', function () {
                $('#home-search-form')[0].reset();

                fullCountrySelectContainer.selectize.clear();
                tiVals.empty();
                attrVals.empty();
            });

            $('#tosearch').on('click', function () {
                $('#id_fulltext_keywords').val('');
                quickCountrySelect.selectize.clear();
                if ($(this).hasClass('on')) {
                    $('#advance-search #full-search').stop().slideUp(300, function () {
                        $('#tosearch').removeClass('on');
                    });
                    $('#advance-search').addClass('quick');
                    $('#advance-search #quick-search').stop().slideDown(100);
                    $('#tosearch').animate({bottom: 20}, 50);
                } else {
                    $('#advance-search #full-search').stop().slideDown(500, function () {
                        $('#tosearch').addClass('on');
                    });
                    $('#advance-search').removeClass('quick');
                    $('#advance-search #quick-search').stop().slideUp(200);
                    $('#tosearch').animate({bottom: -30}, 50);
                }
            });

            $('#quick-search-button').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                fullCountrySelectContainer.selectize.clear();
                $('#panel-basic').children('input, select').val("");
                $('#panel-theme').children('input, select').val("");
                $('#panel-character').children('input, select').val("");
                $('#default').trigger('click');
            });
        });

        $('#default').on('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            $('#home-search-form').submit();
        });

        /* Map/Data Filter Buttons */
        $(window).load(is.verticalResize);

        $('.content-section .bt-prev').addClass('disable');
        
        $('.map-icons a:not(#toexpand)').each(function () {
            var tt = $(this).find('h3').html(),
                title = tt.replace('<br>', ' ');
            title = '☐ ' + title;
            $(this).find('.pop').prepend('<h4>' + title + '</h4>');
        });

        $('.map-icons a:not(.disable)').on('mouseenter', function () {
            if (!$('.map-icons').hasClass('on')) {
                $(this).find('.pop').show().css({opacity: 0}).animate({right: 66, opacity: 1}, 300);
            }
        });
        $('.map-icons a:not(.disable)').on('mouseleave', function () {
            $('.map-icons .pop').fadeOut(50);
            if (!$('.map-icons').hasClass('on')) {
                $(this).find('.pop').animate({right: 52, opacity: 0}, 100, function () {
                    $(this).removeAttr('style');
                });
            }
        });

        /*
            ==== Icon filter button click listener ==== 
        */

        $('.map-icons a:not(.disable)').on('click', function () {
            var icon = $(this).attr('id');
            if ($(this).hasClass('on')) {
                // Turn off the "show all" button
                if (icon == 'all') {
                    $('.map-icons a').removeClass('on');
                } else {
                    $( this ).removeClass('on');
                    $( this ).find('h4').html(
                        $( this ).find('h4').html().replace('☑', '☐')
                    );
                }
            } else {
                if (icon == 'all') {
                    $('.map-icons a:not(.disable)').addClass('on');
                } else {
                    $( this ).addClass('on');
                    $( this ).find('h4').html(
                        $( this ).find('h4').html().replace('☐', '☑')
                    );
                }
            }

            loadData2();
            SaveFilterButtonStatus();
        });

        $('#tosearch').on('click', function () {
            if ($(this).hasClass('on')) {
                $('#advance-search #full-search').stop().slideUp(300, function () {
                    $('#tosearch').removeClass('on');
                });
                $('#advance-search').addClass('quick');
                $('#advance-search #quick-search').stop().slideDown(100);
                $('#tosearch').animate({bottom: 20}, 50);    //original bottom value was -42.  Ji.
            } else {
                $('#advance-search #full-search').stop().slideDown(500, function () {
                    $('#tosearch').addClass('on');
                });
                $('#advance-search').removeClass('quick');
                $('#advance-search #quick-search').stop().slideUp(200);
                $('#tosearch').animate({bottom: -30}, 50);
            }
        });

        $('#q-search').on('focusout', function () {
            var keywords = $('#q-search').val();
            $('#home-search-form')[0].reset();
            $('#q-search').val(keywords);
            $('#id_keywords').val($('#q-search').val());
        });

        $('#id_keywords').on('focusout', function () {
            $('#q-search').val($('#id_keywords').val());
        });

        $('.accordion a').on('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            var that = $(this),
                parent = $(this).parent(),
                content = parent.find('.content');
            if (parent.hasClass('active')) {
                content.slideUp('200', function () {
                    parent.removeClass('active');
                });
            } else {
                content.slideDown('300', function () {
                    parent.addClass('active');
                });
            }
        });

        $(':input[required]').each(function () {
            var idd = $(this).attr('id');
            $('label[for="' + idd + '"]').append('<sup>*</sup>');
        });
        $('.bt-prev').click(function () {
            $('.tabs .active').prev().find('a').trigger('click');
            is.visibleCheck();
        });
        $('.bt-next').click(function () {
            $('.tabs .active').next().find('a').trigger('click');
            is.visibleCheck();
        });

        $('nav .tab-title').hover(function () {
            $(this).find('.pop').css({'display': 'block', opacity: 0}).animate({bottom: '120%', opacity: 1}, 200);
        }, function () {
            $(this).find('.pop').animate({bottom: '103%', opacity: 0}, 100, function () {
                $(this).hide();
            });
        });

        // Turn on all filters
        if (GlobalNewLoad) {
            // Loading default filter buttons'
            for(i = 0; i < 10; i++)
                $('nav.map-icons a:nth-child(' + i + ')').addClass('on');
            $('nav.map-icons a:last-child').addClass('on');
            SaveFilterButtonStatus();
        } else {
            // Loading saved filter buttons
            var indexOfFiltersToTurnOn = localStorage.getItem("filterButtonCache").split(',');
            for (var i = 0; i < indexOfFiltersToTurnOn.length; i++) {
                var index = indexOfFiltersToTurnOn[i];
                $($('.map-icons a')[index]).addClass('on');
            }
        }

        $('.map-icons .on h4').each(function(){
            $( this ).html($( this ).html().replace('☐', '☑'));
        });

        /*
            ===== Leaflet =====
        */

        $(".tabs>li").click(function () {
            if (GlobalMapHandle) {
                L.Util.requestAnimFrame(GlobalMapHandle.invalidateSize, GlobalMapHandle, !1, GlobalMapHandle._container);
            }
        });

        var markers = L.markerClusterGroup({
            // Map markers dynamically set via ajax
            spiderfyDistanceMultiplier: 2,
            maxClusterRadius: 30,
            iconCreateFunction: function (cluster) {
                var childCount = cluster.getChildCount();
                return new L.DivIcon({
                    html: '<div><span>' + childCount + '</span></div>',
                    className: 'marker-cluster marker-cluster-large',
                    iconSize: [32, 32]
                });
            }
        });

        // Prepare everything in map except markers
        var GlobalMapHandle = null;
        var GlobalTableHandle = null;


        var table = $('#record-table-result').DataTable({
                    "retrieve": true,
                    "autoWidth": false
        });

        var geojson, choroControl, legend, extloadChoropleth;

        var min = Number.MAX_SAFE_INTEGER;
        var max = Number.MIN_SAFE_INTEGER;

        // Flag used to check if the DOM is ready
        var isReady = false;
        $(window).load(function () {
            isReady = true;
        });

        function map_init_basic(map, options) {
            GlobalMapHandle = map;


            // Showing Loading Overlay on map init.
            $("#map-loading-overlay").fadeIn(100);

            //Set bounds for the map
            map.setMaxBounds([[-70,-180],[90,180]]);

            // Remove default layers
            map.eachLayer(function (Layer) {
                map.removeLayer(Layer)
            });

            // Add history control
            new L.control.navbar().addTo(map);

            // Custom TileLayer required for Bing
            var BingLayer = L.TileLayer.extend({
                getTileUrl: function (tilePoint) {
                    this._adjustTilePoint(tilePoint);
                    return L.Util.template(this._url, {
                        s: this._getSubdomain(tilePoint),
                        q: this._quadKey(tilePoint.x, tilePoint.y, this._getZoomForUrl())
                    });
                },
                _quadKey: function (x, y, z) {
                    var quadKey = [];
                    for (var i = z; i > 0; i--) {
                        var digit = '0';
                        var mask = 1 << (i - 1);
                        if ((x & mask) != 0) {
                            digit++;
                        }
                        if ((y & mask) != 0) {
                            digit++;
                            digit++;
                        }
                        quadKey.push(digit);
                    }
                    return quadKey.join('');
                }
            });

            // Setup basemaps
            var mqAttr = 'basemap data &copy; <a href="http://openstreetmap.org" target="_blank">OpenStreetMap</a> contributors, ' +
                '<a href="http://creativecommons.org/licenses/by-sa/2.0/" target="_blank">CC-BY-SA</a>, ' +
                'basemap &copy; <a href="http://mapquest.com" target="_blank">MapQuest</a>';
            var mqUrl = 'http://otile1.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.png';
            var mqOSM = L.tileLayer(mqUrl, {attribution: mqAttr, noWrap: true});
            var mbAttr = 'basemap data &copy; <a href="http://openstreetmap.org" target="_blank">OpenStreetMap</a> contributors, ' +
                '<a href="http://creativecommons.org/licenses/by-sa/2.0/" target="_blank">CC-BY-SA</a>, ' +
                'basemap &copy; <a href="http://mapbox.com" target="_blank">Mapbox</a>';
            var mbUrl = 'https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png';
            var osmUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
            var osmAttr = 'basemap data &copy; <a href="https://openstreetmap.org" target="_blank">OpenStreetMap</a> contributors, ' +
                'basemap &copy; <a href="https://openstreetmap.org" target="_blank">OpenStreetMap</a>';
            var osm = L.tileLayer(osmUrl, {attribution: osmAttr, noWrap: true});
            var esriAttr = 'basemap &copy; <a href="http://esri.com" target="_blank">Esri</a>';
            var esriUrl = 'https://services.arcgisonline.com/ArcGIS/rest/services/{id}/MapServer/tile/{z}/{y}/{x}';
            var esriImagery = L.tileLayer(esriUrl, {id: 'World_Imagery', attribution: esriAttr, noWrap: true});
            var esriStreet = L.tileLayer(esriUrl, {id: 'World_Street_Map', attribution: esriAttr, noWrap: true});
            var choroBase = L.tileLayer(esriUrl, {id: 'World_Street_Map', attribution: esriAttr, noWrap: true});
            var esriOcean = L.tileLayer(esriUrl, {id: 'Ocean_Basemap', attribution: esriAttr, noWrap: true});
            var esriNatGeo = L.tileLayer(esriUrl, {id: 'NatGeo_World_Map', attribution: esriAttr, noWrap: true});
            var bingKey = 'Al1mXkJObbAqh8s8TkCwTnIYZOemobAiJZSVaPklNXPS_ErYDtPButHlPDJrznFf';
            var bingAttr = 'basemap &copy; <a href="https://bing.com/maps" target="_blank">Bing Maps</a>';
            var bingAerialUrl = 'https://t{s}.tiles.virtualearth.net/tiles/a{q}.jpeg?g=1398&key=' + bingKey;
            var bingRoadsUrl = 'https://t{s}.tiles.virtualearth.net/tiles/r{q}.jpeg?g=1398&key=' + bingKey;
            var bingAerial = new BingLayer(bingAerialUrl, {
                subdomains: ['0', '1', '2', '3', '4'],
                attribution: bingAttr,
                noWrap: true
            });
            var bingRoads = new BingLayer(bingRoadsUrl, {
                subdomains: ['0', '1', '2', '3', '4'],
                attribution: bingAttr,
                noWrap: true
            });
            var baseLayers = {
                "OpenStreetMap": osm,
                "Esri Imagery": esriImagery,
                "Esri Street": esriStreet,
                "Esri Ocean": esriOcean,
                "Esri National Geographic": esriNatGeo,
                "Bing Aerial": bingAerial,
                "Bing Roads": bingRoads,
            };

            function getColor(d) {
                var quarts = quantScale.quantiles();
                var l = quarts.length - 1;
                if (d >= 0 && d !== null) {
                    if (d === quantScale(quarts[l])) {
                        return '#fe9929';
                    }
                    else if (quantScale(quarts[l - 1]) <= d && d < quantScale(quarts[l])) {
                        return '#f9bb3e';
                    }
                    else if (quantScale(quarts[l - 2]) <= d && d < quantScale(quarts[l - 1])) {
                        return '#ffda6b';
                    }
                    else if (quantScale(quarts[l - 3]) <= d && d < quantScale(quarts[l - 2])) {
                        return '#fcf09c';
                    }
                    else if (d < quantScale(quarts[l - 3])) {
                        return '#ffffe5';
                    }
                    else {
                        return '#ffffff';
                    }
                } else {
                    return '#d6d6d6';
                }
            }

            var quantScale;

            function style(feature) {
                var choroProp = localStorage.getItem('choroProp');

                if (!choroProp) {
                    choroProp = "SubMap2_SSF_2";
                }

                var featProp = feature.properties[choroProp];
                var colourVal;
                if (featProp !== null) {
                    colourVal = quantScale(featProp);
                    if (colourVal < 0) {
                        colourVal = 0;
                    }
                }
                else {
                    colourVal = null;
                }

                return {
                    fillColor: getColor(colourVal),
                    weight: 2,
                    opacity: 1,
                    color: 'white',
                    dashArray: '',
                    fillOpacity: 0.7
                };
            }

            function highlightFeature(e) {
                var layer = e.target;
                layer.setStyle({
                    weight: 5,
                    color: '#666',
                    dashArray: '',
                    fillOpacity: 0.7,
                    opacity: 0.7
                });

                if (!L.Browser.ie && !L.Browser.opera) {
                    layer.bringToFront();
                }

                choroControl.update(layer.feature.properties);
            }

            function resetHighlight(e) {
                var layer = e.target;
                geojson.setStyle(style);
                choroControl.update(layer.feature.properties);
            }

            function zoomToFeature(e) {
                map.fitBounds(e.target.getBounds());
            }

            var prop_vals = [];

            function onEachFeature(feature, layer) {
                prop_vals.push(feature.properties[localStorage.getItem("choroProp")]);
                layer.on({
                    mouseover: highlightFeature,
                    mouseout: resetHighlight,
                    click: zoomToFeature
                });
            }

            // Custom info popup for choropleth layer
            choroControl = L.control();

            choroControl.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'choroControl'); // create a div with a class "info"
                this.update();
                return this._div;
            };

            function formatChoroProp(x, sep, grp) {
                if (x === null || x === "-") return "No Data";
                var num = Math.round(x);
                if (x.length > 3) {
                    var sx = ('' + num).split('.'), s = '', i, j;
                    sep || (sep = ','); // default seperator
                    grp || grp === 0 || (grp = 3); // default grouping
                    i = sx[0].length;
                    while (i > grp) {
                        j = i - grp;
                        s = sep + sx[0].slice(j, i) + s;
                        i = j;
                    }
                    s = sx[0].slice(0, i) + s;
                    sx[0] = s;
                    return sx.join('.');
                } else {
                    return num;
                }
            }

            // Method used to update the control based on feature properties passed
            choroControl.update = function (props) {
                this._div.innerHTML = (props ? '<h5><b>' + props.name + '</b></h5>' +
                    localStorage.getItem('choroPropTitle') + ': ' +
                    formatChoroProp(props[localStorage.getItem("choroProp")]) : 'Hover over a country');
            };

            // Legend for choropleth layer
            legend = L.control({position: 'bottomleft'});

            legend.onAdd = function (map) {
                var div = L.DomUtil.create('div', 'info legend');
                var grades = [];
                labels = [];

                div.style.maxWidth = '60%';
                div.style.fontSize = '10pt';
                var choroSelect = '<select id="choroProps">';
                // Get any layer from geojson since all have the same properites
                var layer = geojson.getLayers()[0];
                var props = Object.keys(layer.feature.properties);
                var optionTitle, optionUnits, optionVal;
                for (var i = 0; i < props.length; i++) {
                    if (props[i].includes("SSF_")) {
                        optionTitle = layer.feature.properties[props[i]];
                        optionVal = layer.feature.properties[props[i + 1]];
                        optionUnits = layer.feature.properties[props[i + 2]];
                        choroSelect += '<option id="' + optionVal + '" value="' + props[i + 1] + '" ';

                        //set selected option to current choropleth property
                        if (props[i + 1] === localStorage.getItem("choroProp")) {
                            choroSelect += 'selected="selected"'
                        }
                        choroSelect += '>' + optionTitle + ' (' + optionUnits + ')' + '</option>';
                        i += 2;
                    }
                }
                choroSelect += '</select>';
                div.innerHTML += choroSelect;

                div.innerHTML += '<i style="background: #d6d6d6"></i> No data</br>';
                var quantiles = quantScale.quantiles();
                if (quantiles[0]) {
                    quantiles.unshift(0);
                }
                for (var i = 0; i < quantiles.length; i++) {
                    div.innerHTML +=
                        '<i style="background:' + getColor(quantScale(quantiles[i])) + '"></i> ' +
                        (Math.round(quantiles[i]) + (i===0?0:1)) + (Math.round(quantiles[i + 1]) >= 0 ? '&ndash;' +
                        Math.round(quantiles[i + 1]) + '<br>' : '+');
                }

                var stop = L.DomEvent.stopPropagation;
                L.DomEvent
                    .on(div, 'click', stop)
                    .on(div, 'mousedown', stop);

                return div;
            };

            lastSelectedLayer = localStorage.getItem("lastselectedlayer");
            if (lastSelectedLayer === null) {
                osm.addTo(map);
            }

            // Make sure lastSelectedLayer exists and loop through
            // list of all baselayers and apply the one that matches it
            if (typeof lastSelectedLayer !== "undefined") {
                for (layer in baseLayers) {
                    if (lastSelectedLayer === layer) {
                        baseLayers[lastSelectedLayer].addTo(map);
                        if (lastSelectedLayer === "Country Statistics") {
                            loadChoropleth();
                        }
                    }
                }
            }

            var options = {
                text: 'Locate placename using Bing',
                position: 'bottomright'
            };

            new L.Control.BingGeocoder(bingKey, options).addTo(map);

            var mrUrl = 'http://geo.vliz.be/geoserver/MarineRegions/wms';

            // Setup overlay layers
            var mrAttr = 'marine regions &copy; <a href="http://Marineregions.org" target="_blank">Marineregions.org</a>';
            var mrEEZ = L.tileLayer.wms(mrUrl, {
                layers: 'MarineRegions:eez',
                attribution: mrAttr,
                format: 'image/png',
                transparent: true,
                noWrap: true
            });
            var mrLME = L.tileLayer.wms(mrUrl, {
                layers: 'MarineRegions:lme',
                attribution: mrAttr,
                format: 'image/png',
                transparent: true,
                noWrap: true
            });
            var mrFAO = L.tileLayer.wms(mrUrl, {
                layers: 'MarineRegions:fao',
                attribution: mrAttr,
                format: 'image/png',
                transparent: true,
                noWrap: true
            });
            var overlayLayers = {
                "Exclusive Economic Zones": mrEEZ,
                "Large Marine Ecosystems": mrLME,
                "FAO Fishing Areas": mrFAO
            };

            var choroToggle = L.control({position: 'bottomright'});
            choroToggle.onAdd = function (map) {
                var div = L.DomUtil.create('div', 'choroToggle');
                div.title = 'Toggle country statistics overlay';
                div.style.background = '#f8f8f9';
                div.style.backgroundImage = 'url("static/issf_base/img/icon-data.png")';
                div.style.backgroundPosition = '92.5% 50%';
                div.style.backgroundRepeat = 'no-repeat';
                div.style.boxShadow = '0 1px 7px #999';
                div.style.borderRadius = '8px';
                div.style.width = '36px';
                div.style.height = '36px';

                L.DomEvent.on(div, 'mouseover', function () {
                    div.style.cursor = 'pointer';
                });
                L.DomEvent.on(div, 'click', toggleChoropleth);

                function toggleChoropleth() {
                    if (geojson && geojson._map) {
                        map.removeLayer(geojson);
                        map.removeControl(choroControl);
                        map.removeControl(legend);

                        $('.map-icons a').addClass('on');
                        loadData2();
                    } else {
                        loadChoropleth();
                    }
                }
                return div;
            };
            choroToggle.addTo(map);

            // Add basemaps and overlays
            L.control.layers(baseLayers, overlayLayers, {position: 'bottomright'}).addTo(map);

            // Add empty markers group layer
            map.addLayer(markers);

            // Detects if user manually changed the baselayer and saves it
            // to be restored if the page is opened again
            map.on('baselayerchange', function (e) {
                lastSelectedLayer = e.name;
                localStorage.setItem("lastselectedlayer", lastSelectedLayer);

                // User selected choropleth layer
                if (e.name === "Country Statistics") {
                    loadChoropleth();
                } else {
                    map.removeLayer(geojson);
                    map.removeControl(choroControl);
                    map.removeControl(legend);
                    $('.map-icons a').addClass('on');
                    loadData2();
                }
            });

            // This flag is needed to check if LoadChoropleth was loaded internally.
            var initialLoad = true;

            function loadChoropleth() {
                if (isReady) {
                    $('.map-icons a').removeClass('on');
                    loadData2();
                    if (geojson) {
                        map.removeLayer(geojson);
                    }
                    geojson = L.geoJson(choroData, {onEachFeature: onEachFeature});
                    quantScale = d3.scaleQuantile().domain(prop_vals).range([0, 20, 40, 60, 80]);
                    prop_vals = [];
                    geojson.setStyle(style);
                    geojson.addTo(map);

                    if (($('div.info.legend').length)) {
                        map.removeControl(choroControl);
                        map.removeControl(legend);
                    }
                    choroControl.addTo(map);
                    legend.addTo(map);
                    $('#choroProps').on('change', function () {
                        localStorage.setItem('choroProp', $(this).children(':selected').attr('value'));
                        localStorage.setItem('choroPropTitle', $(this).children(':selected').text());
                        max = min = 0;
                        initialLoad = false;
                        loadChoropleth();
                    });
                    // Function called externally, need to reload to set
                    // choropleth property data. It's not pretty, but it works.
                    if (initialLoad) {
                        $('#choroProps').change();
                    }
                }
            }


            // Add transparent tooltipPopsup markers for key geographic scopes
            // they are rounded red squares, definitely could be a more visually-pleasing design
            var scopeIcon = new L.DivIcon({
                className: 'scope-icon', iconSize: [32, 32],
                opacity: 0
            });
            L.marker([-10, -10], {
                icon: scopeIcon, title: 'Global scope', zIndexOffset: 1000,
                clickable: true
            }).addTo(map);
            L.marker([-40, 65], {
                icon: scopeIcon, title: 'Geographic scope not specific',
                zIndexOffset: 1000, clickable: true
            }).addTo(map);
            L.marker([23, 23], {
                icon: scopeIcon, title: 'Regional scope - Africa',
                zIndexOffset: 1000, clickable: true
            }).addTo(map);
            L.marker([45, 90], {
                icon: scopeIcon, title: 'Regional scope - Asia',
                zIndexOffset: 1000, clickable: true
            }).addTo(map);
            L.marker([16, -77], {
                icon: scopeIcon, title: 'Regional scope - Caribbean',
                zIndexOffset: 1000, clickable: true
            }).addTo(map);
            L.marker([50, 15], {
                icon: scopeIcon, title: 'Regional scope - Europe',
                zIndexOffset: 1000, clickable: true
            }).addTo(map);
            L.marker([-21, -55], {
                icon: scopeIcon, title: 'Regional scope - Latin America',
                zIndexOffset: 1000, clickable: true
            }).addTo(map);
            L.marker([49, -111], {
                icon: scopeIcon, title: 'Regional scope - North America',
                zIndexOffset: 1000, clickable: true
            }).addTo(map);
            L.marker([-18, 154], {
                icon: scopeIcon, title: 'Regional scope - Oceania',
                zIndexOffset: 1000, clickable: true
            }).addTo(map);

            // The condition for restoring zoom/pan after user has hit "back" button
            // to return to page are: cached mapzoom, cached mapcenter
            map.on('move', function () {
                localStorage.removeItem("mapcenter");
                localStorage.removeItem("mapzoom");
            });

            // Make ajax call to get data
            if (GlobalNewLoad) {
                $.ajax({
                    type: "GET",
                    url: "{% url 'frontend-data' %}",
                    dataType: "json",
                    data: null,
                    success: (data) => {
                        loadData(data)
                    }
                });
            } else {
                var tempJsonData = {};
                tempJsonData.success = 'true';
                tempJsonData.mapData = [];

                // Restore map data
                tempJsonData.mapData = JSON.parse(window.sessionStorage.getItem('cache_map_data'));

                // Restore search data
                tempJsonData.searchTerms = localStorage.getItem('searchTerms');
                loadData(tempJsonData);
            }
        }

        var search = false;

        // If user is not signed in then disable button and have tooltipPopsup asking them to login.
        // Have to "fake-disable" the button with onclick="return false because the tooltipPopsup will
        // not appear if it is actually disabled.
        //TODO: Enable export again
        //$('#quick-button-floaty').append('<span data-tooltipPopsup aria-haspopup="true" class="has-tip exp-tip" title="Please login to use the export feature." style="border:none;"><button class="medium radius exportButton" onclick="return false;">Export</button></span>');

        {% if user.is_authenticated %}
            $('span.exp-tip').prop('title', "Export selected data in CSV format.");
            $('button.exportButton').attr('data-reveal-id', "exportModal");
        {% endif %}

        // Load clickable map image in dashboard panel
        $('#regional').load('/static/frontend/img/worldmap.svg', svgLoaded);

        function goToTable() {
            $(".totable").click();
        }

        $('.totable').on('click', function () {
            $('.dataTables_scrollHeadInner, .dataTables_scrollHeadInner table').width('100%');
        });

        $('#home-search-form').keydown(function (e) {
            if (e.keyCode === 13) {
                e.preventDefault();
                e.stopPropagation();
                $('#home-search-form').submit();
            }
        });

        // Search submit
        $('#home-search-form').submit(function (e) {
            e.preventDefault();
            e.stopPropagation();

            // Showing Loading Overlay
            $("#map-loading-overlay").fadeIn(100);

            var form = $(this);
            search = true;

            $.ajax({
                type: "POST",
                url: "{% url 'frontend-data' %}",
                dataType: "json",
                data: form.serialize(),
                success: function(data){
                    loadData(data)
                }
            });
        });

        var GlobalJsonData = null;

        // Trampoline function to loadData.
        // this function is to be called whenever there is a click on filter buttons
        function loadData2() {
            loadData(GlobalJsonData);
        }

        // Holds the core ids of the records currently in the table
        var currentRecords = [];

        // ajax callback function
        function loadData(jsonData) {
            // Check for and Back up the jsonData
            if (jsonData == null || typeof jsonData == 'undefined') {
                return;
            }
            GlobalJsonData = jsonData;

            // Get the list of filters
            var activeFilters = [];
            var filterTitle;
            $('nav.map-icons a').each(function () {
                if ($(this).hasClass('on')) {
                    filterTitle = $(this).children('h3').text();
                    if (filterTitle == "Experiences") {
                        filterTitle = "SSF Experiences";
                    }
                    if (filterTitle == "Blue Justice Alerts") {
                        filterTitle = "SSF Blue Justice";
                    }
                    if (filterTitle == "Case Studies") {
                        filterTitle = "Case Study";
                    }
                    activeFilters.push(filterTitle);
                }
            });

            if (jsonData.success == 'false') {
                $('#searchTerms').html(jsonData.msg);
                $('#searchTerms').addClass('error');
            }
            else {
                /* Update map */

                markers.clearLayers();
                map = markers._map;
                map.options.minZoom = 2;
                map.removeLayer(markers);

                var mapDataSource = jsonData.mapData;

                var defaultIconProps = {
                    iconSize: [24, 24],
                    iconAnchor: [12, 12],
                    popupAnchor: [0, 0]
                };

                var icons = {
                    "Who's Who in SSF": L.icon(Object.assign(defaultIconProps, {
                        iconUrl: '{% static "img/icon-who.png" %}'
                    })),
                    "State-of-the-Art in SSF Research": L.icon(Object.assign(defaultIconProps, {
                        iconUrl: '{% static "img/icon-sota.png" %}'
                    })),
                    "SSF Organization": L.icon(Object.assign(defaultIconProps, {
                        iconUrl: '{% static "img/icon-organizations.png" %}'
                    })),
                    "SSF Governance": L.icon(Object.assign(defaultIconProps, {
                        iconUrl: '{% static "img/icon-capacity.png" %}'
                    })),
                    "SSF Profile": L.icon(Object.assign(defaultIconProps, {
                        iconUrl: '{% static "img/icon-profile.png" %}'
                    })),
                    "SSF Guidelines": L.icon(Object.assign(defaultIconProps, {
                        iconUrl: '{% static "img/icon-guidelines.png" %}'
                    })),
                    "SSF Experiences": L.icon(Object.assign(defaultIconProps, {
                        iconUrl: '{% static "img/icon-experiences.png" %}'
                    })),
                    "SSF Blue Justice": L.icon(Object.assign(defaultIconProps, {
                        iconUrl: '{% static "img/icon-bluejustice.gif" %}'
                    })),
                    "Case Study": L.icon(Object.assign(defaultIconProps, {
                        iconUrl: '{% static "img/icon-casestudies.png" %}'
                    })),
                    "Unknown": L.icon(Object.assign(defaultIconProps, {
                        iconUrl: '{% static "img/icon-unknown.png" %}'
                    }))
                };

                currentRecords = [];
                var notShown = {
                    "Global": 0,
                    "Not specific": 0
                };

                //Removes duplicates and merges entries in case they are dupe but one of them does not have coordinate points to be shown in the map.
                var dupe_hashmap = {};
                for (var i = 0; i < mapDataSource.length; i++) {
                    // The summary of the record that appears in the table, used to determine duplicates
                    var tableItem = mapDataSource[i];
                    var summary = tableItem[2];

                    if (summary in dupe_hashmap) {
                        //Fill missing coordinates (if any) in the selected entry
                        if((tableItem[3] != undefined && tableItem[4] != undefined) && 
                        (dupe_hashmap[summary][3] == undefined && dupe_hashmap[summary][3] == undefined)){
                            //Assign values to the current entry
                            dupe_hashmap[summary][3] = tableItem[3];
                            dupe_hashmap[summary][4] = tableItem[4];
                        }
                    } else {
                        dupe_hashmap[summary] = tableItem
                    }
                }


                mapDataSourceClean = [];

                for (var key in dupe_hashmap) {

                    if (dupe_hashmap.hasOwnProperty(key)) {           
                        mapDataSourceClean.push(dupe_hashmap[key]);
                    }
                }

                //Assing the new clean array
                mapDataSource = mapDataSourceClean;



                //Update the record count in the buttons
                var records_counts = {};

                for (var i = 0; i < mapDataSource.length; i++) {
                    var row = mapDataSource[i]
                    var recordType = row[0];

                    if(records_counts[recordType] == undefined){
                        records_counts[recordType] = 1;
                    }else{
                        records_counts[recordType] = records_counts[recordType] + 1;
                    }
                }

                for (var property in records_counts) {
                    if (records_counts.hasOwnProperty(property)) {
                        var prop_to_replace;

                        if(property == "Case Study"){
                            prop_to_replace = "Case Studies";
                        }else if(property == "SSF Blue Justice"){
                            prop_to_replace = "Blue Justice Alerts";
                        }else{
                            prop_to_replace = property;
                        }

                        $("h3:contains("+prop_to_replace+")").siblings().find('strong').text(records_counts[property]+" records.");
                    }
                }

                var current_map_state = []

                for (newRow in mapDataSource) {
                    var row = mapDataSource[newRow];
                    var rowAsJsonString = JSON.stringify(row);

                    // Save the data to #hiddenmapdata
                    if (typeof rowAsJsonString === "undefined") {
                        break;
                    }

                    if (row[1] === "Global" || row[1] === "Not specific") {
                        notShown[row[1]] += 1;
                    }

                    current_map_state.push(row)

                    for (var i = 0; i < activeFilters.length; i++) {

                        if (row[0] == activeFilters[i]) {
                            var currentIcon = icons[row[0]];

                            //FIXME: As some records in the database do not have a map point specified we need to ignore records with (None, None) coords.
                            if(row[5] != "None" && row[4] != "None") {

                                var mrk = L.marker([row[5], row[4]], {icon: currentIcon});
                                mrk.bindPopup(
                                    '<b>Record type:</b> ' + row[0] +
                                    '<br><b>Geographic scope:</b> ' + row[1] +
                                    '<br><br>' + row[2] +
                                    '<br><br>' + row[3]
                                );
                                markers.addLayer(mrk);
                                var urlString = row[3].split('/');
                                currentRecords.push(row[0] + '&' + urlString[3]);

                            }

                        }
                    }
                }

                //Set map data in cache
                window.sessionStorage.setItem('cache_map_data', JSON.stringify(current_map_state));

                var notShownGlobalLatLng = L.latLng(-22.5, -10)
                var notShownGlobalMarker = L.marker(notShownGlobalLatLng, {icon: icons["Unknown"]});
                notShownGlobalMarker.bindPopup(
                    'Some items have a location of "Global"<br /><a onclick="goToTable();">Find them in the table</a>'
                );
                if (notShown["Global"] > 0) {
                    markers.addLayer(notShownGlobalMarker);
                }

                var notShownNotSpecLatLng = L.latLng(-35, 50)
                var notShownNotSpecMarker = L.marker(notShownNotSpecLatLng, {icon: icons["Unknown"]});
                notShownNotSpecMarker.bindPopup(
                    'Some items don\'t have a specific location<br /><a onclick="goToTable();">Find them in the table</a>'
                );
                if (notShown["Not specific"] > 0) {
                    markers.addLayer(notShownNotSpecMarker);
                }


                map.addLayer(markers);

                /* Update table */
                table.clear();


                // Order by relevance after performing a search
                /*if (search) {
                    table.order([3, 'desc']);
                } else {
                    table.order([2, 'desc']);
                }*/


                for (newRow in mapDataSource) {
                    
                    if (typeof JSON.stringify(mapDataSource[newRow]) === "undefined") {
                        break;
                    }

                    for (var i = 0; i < activeFilters.length; i++) {
                        if (mapDataSource[newRow][0] == activeFilters[i]) {
                            var url = mapDataSource[newRow][3];
                            url = url.split('"');

                            var summary = '<a href="' + url[1] + '">' + mapDataSource[newRow][2] + '</a>';
                            // Retrieve table data from map data to reduce amount of data transferred
                            table.row.add([mapDataSource[newRow][0], summary, mapDataSource[newRow][6], mapDataSource[newRow][7]]);
                        }
                    }
                }

                table.draw();

                // Update Search terms
                var searchterms = jsonData.searchTerms;
                localStorage.setItem('searchTerms', searchterms);
                $('#searchTerms').html("");
                if (searchterms !== null && searchterms !== "null" && searchterms !== "undefined" && typeof searchterms !== "undefined") {
                    var totalNotShown = notShown["Global"] + notShown["Not specific"];
                    var notShownText = totalNotShown > 0 ? ', ' + String(totalNotShown) + ' not plotted on map' : '';

                    var searchTerms = "<strong>Current Search Terms:</strong> " + searchterms + mapDataSource.length + " records" + notShownText + ")";
                    $('#searchTerms').html(searchTerms);
                }

                // Hack: if you do this without a pause, it can cause map freeze because it not initialized!
                setTimeout(function () {
                    // Restore map zoom and center if NOT new page load
                    if (localStorage.getItem("mapcenter") && localStorage.getItem("mapzoom") && !GlobalNewLoad && !GlobalMapChangeFlag) {
                        map.setView(JSON.parse(localStorage.getItem("mapcenter")), localStorage.getItem("mapzoom"));
                    }
                }, 2000);

                // Restore table page and order if NOT new page load
                if (localStorage.getItem("tableorder") && localStorage.getItem("tablepage") && localStorage.getItem("recordPerPage") && !GlobalNewLoad) {
                    table.order(JSON.parse(localStorage.getItem("tableorder"))).page.len(parseInt(localStorage.getItem("recordPerPage"))).page(parseInt(localStorage.getItem("tablepage"))).draw(false);
                }

                // Hide Loading Overlay
                $("#map-loading-overlay").fadeOut(100);

                var contained = [];

                map.eachLayer(function(l) {
                    if( l instanceof L.Marker )
                        contained.push(l.getLatLng());
                });
                if(contained.length < 100)
                var bounds = new L.LatLngBounds(contained);
                map.fitBounds(bounds);
            }
            exportCallBack = true;
        }

        var buttonClicked;
        // exportCallback gets set to true at the end of the loadData call if the export button was
        // clicked so it will wait until loadData finishes before letting the user export the data.
        // this is basically for impatient  users who like to rapidly click buttons without knowing what they do.
        var exportCallBack = false;

        function exportData() {
            $('#exportModal').foundation('reveal', 'close');
            buttonClicked = "export";

            if (exportCallBack) {
                $.ajax({
                    type: "POST",
                    url: "{% url 'data-export' %}",
                    dataType: "json",
                    data: {'ids': currentRecords, csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value},
                    complete: function () {
                        window.location.replace("{% url 'data-export' %}");
                    }
                });
                exportCallBack = true;
            }
        }

        // Behaviour for clickable map in dashboard panel
        function svgLoaded() {
            $('#regional g').click(function () {
                var gid = $(this).attr('id');
                // Replace PDF URL under this line
                if (gid == 'latin_america') {
                    window.open('http://toobigtoignore.net/wp-content/uploads/2014/09/latin.america.poster.final_.pdf');
                }
                else if (gid == 'africa') {
                    window.open('http://toobigtoignore.net/wp-content/uploads/2014/09/africa.poster.final_.pdf');
                }
                else if (gid == 'europe') {
                    window.open('http://toobigtoignore.net/wp-content/uploads/2014/09/europe.poster.final_.pdf');
                }
                else if (gid == 'north_america') {
                    window.open('http://toobigtoignore.net/wp-content/uploads/2014/09/north.america.poster.final_.pdf');
                }
                else if (gid == 'asia_oceania') {
                    window.open('http://toobigtoignore.net/wp-content/uploads/2014/09/asia.oceania.poster.final_.pdf');
                }
            });
            $('#regional g').mouseover(function (e) {
                var region = $(this).attr('id'),
                    rgname = region.replace('_', ' ');
                $('<div class="info_popup">' + rgname + '</div>').appendTo('body');
            })
                .mouseleave(function () {
                    $('.info_popup').remove();
                })
                .mousemove(function (e) {
                    var mouseX = e.pageX, // x coordinates of mouse
                        mouseY = e.pageY; // y coordinates of mouse
                    $('.info_popup').css({top: mouseY - 30, left: mouseX - ($('.info_popup').width() / 2)});
                });
        }

        // Custom jquery plugin function
        // Check for the nearest sibling element / cluster icon
        $.fn.getNearestSibling = function (filter) {
            var primaryPosition = this.position();
            var $siblings = $(this).siblings(filter);
            if ($siblings.length == 0) {
                return null;
            } else {
                var $nearestSibling = null;
                $siblings.each(function () {
                    if ($nearestSibling == null) {
                        $nearestSibling = $(this);
                    } else {
                        var distanceFromNearestSibling = getDistanceBetweenPositions(primaryPosition, $nearestSibling.position());
                        var distanceFromCurrentSibling = getDistanceBetweenPositions(primaryPosition, $(this).position());
                        if (distanceFromCurrentSibling < distanceFromNearestSibling) {
                            $nearestSibling = $(this);
                        }
                    }
                });
                return $nearestSibling;
            }
        };

        var getDistanceBetweenPositions = function (pos1, pos2) {
            return Math.sqrt(Math.pow(pos1.left - pos2.left, 2) + Math.pow(pos1.top - pos2.top, 2));
        };

        // Pass clicks on scope-icon through to its overlapped cluster/marker icon

        $(document).on('click', function (evt) {
            // Check if the element being clicked is a scope-icon
            if ($(evt.target).hasClass('scope-icon')) {
                $(evt.target).getNearestSibling('').click();
            }
        });

        // Initialize accordions
        $('div[id*="accordion"]').each(function () {
            $(this).accordion({active: 0, animate: 200});
        });

        $('#advanced-search-tab-container').tabs();

        // Onclick page scroll
        $('.issf-scroll-button').on("click", function (e) {
            var scrollTo = $(this).attr('scrollto');
            if ($(scrollTo).length > 0) {
                $('html, body').animate({
                    scrollTop: $(scrollTo).offset().top
                }, 1000);
            }
        });

        $('#helpRate').click(function (e) {
            e.preventDefault();
            window.location.replace('/details/capacity-need-rating/0/');
        });
    </script>


    <script>
        // add target="_blank" to the element of the tables to open in a new tab
        function addAttrOnTableAnchors(){
            $('#record-table-result a').attr('target','_blank');
        }
        setInterval(addAttrOnTableAnchors,1000);

        
        // VISUALIZATION SECTION
        // RANDOMLY DECIDE WHICH VISUALIZATION SHOULD SHOW WHEN PAGE IS INITIALLY LOADED
        let sliderCount = 0;
        $('.visual-slides').each(function(){
            $('#pager').append("<span class='dot' data-target='" + sliderCount + "'></span>");
            sliderCount++;
        });

        $(window).load(function(){
            // REMOVE MAP LOADING SCREEN WHEN MAP IS LOADED
            $('#visual-loading-overlay').fadeOut();

            // RANDOMLY DECIDE WHICH VISUALIZATION SHOULD SHOW WHEN PAGE IS INITIALLY LOADED
            let randomNum = Math.floor(Math.random() * sliderCount);        // GET A RANDOM NUMBER FROM 0 TO NUMBER OF SLIDER
            $('.visual-slides').eq(randomNum).addClass('active');
            $('#pager .dot').eq(randomNum).addClass('active');

            // DISPLAY SLIDER
            $('.slideshow-container').css('display','block');
            $('#pager').removeClass('hide');
            $('.visual-carousel-control').removeClass('hide');
        });

        // VISUALIZATION SLIDER
        $('#next-slide').on('click',function(){
            if($('.visual-slides.active').next().hasClass('visual-slides')){
                $('.visual-slides.active').removeClass('active').next().addClass('active');
            }
            else{
                $('.visual-slides.active').removeClass('active');   
                $('.visual-slides').first().addClass('active');   
            }
            $('#pager .dot').eq($('.visual-slides.active').data('pager')).addClass('active').siblings().removeClass('active');
        });

        $('#prev-slide').on('click',function(){
            if($('.visual-slides.active').prev().hasClass('visual-slides')){
                $('.visual-slides.active').removeClass('active').prev().addClass('active');
            }
            else{
                $('.visual-slides.active').removeClass('active');   
                $('.visual-slides').last().addClass('active');   
            }
            $('#pager .dot').eq($('.visual-slides.active').data('pager')).addClass('active').siblings().removeClass('active');
        });

        $('#pager .dot').on('click',function(){
            let $this = $(this);
            $this.addClass('active').siblings('.dot').removeClass('active');
            $('.visual-slides').eq($this.data('target')).addClass('active').siblings().removeClass('active');
        });

        
        // MOST RECENT CONTRIBUTION SECTION
        $('.most-recent-contributions-trigger li a').on('click',function(){
            let $this = $(this);
            $this.closest('li').addClass('active').siblings('li').removeClass('active');
            $('.most-recent-contributions-tabs #' + $this.data('tab')).addClass('in active').siblings('.tab-pane').removeClass('in active');
        });
    </script>
    
    <script src="https://www.mapquestapi.com/sdk/leaflet/v2.2/mq-map.js?key=r6zHiLKHtnlqqDuyu2YBfU2JxAnowqE5"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/js/standalone/selectize.min.js"></script>
    <script src="https://malsup.github.io/min/jquery.cycle2.min.js"></script>
    
{% endblock additional_js_scripts %}
